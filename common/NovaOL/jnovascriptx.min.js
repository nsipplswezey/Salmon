function comp_proto(a,b){this.name=a;this.kind=b;this.exp="0.0";this._exp="0.0"}comp_proto.prototype.value=function(){return eval(this.exp)};comp_proto.prototype.getName=function(a){return(a)?a.name:""};comp_proto.prototype.setCap=function(a){this.cap=a;this.controls=a.controls};comp_proto.prototype.isKind=function(a){return this.kind==a};comp_proto.prototype.isIterable=function(){return this.isStock()||this.isSequence()};comp_proto.prototype.isCapsule=function(){return this.isKind("Capsule")||this.isClockedChip()||this.isAgent()||this.isCell()};comp_proto.prototype.isSimulator=function(){return this.isCapsule()||this.isKind("AgentVector")||this.isKind("CellMatrix")||this.isKind("Simworld")||this.isKind("NodeNetwork")||this.isKind("NetWorld")};comp_proto.prototype.isCommand=function(){return this.isKind("Command")};comp_proto.prototype.isFlow=function(){return this.isKind("Flow")};comp_proto.prototype.isTerm=function(){return this.isKind("Term")};comp_proto.prototype.isSequence=function(){return this.isKind("Sequence")};comp_proto.prototype.isStock=function(){return this.isKind("Stock")};comp_proto.prototype.isLVariable=function(){return this.isKind("LVariable")};comp_proto.prototype.isInPin=function(){return this.isKind("InPin")};comp_proto.prototype.isOutPin=function(){return this.isKind("OutPin")};comp_proto.prototype.isAgent=function(){return this.isKind("Agent")};comp_proto.prototype.isCell=function(){return this.isKind("Cell")};comp_proto.prototype.isNode=function(){return this.isKind("Node")};comp_proto.prototype.isCodeChip=function(){return this.isKind("CodeChip")};comp_proto.prototype.isClockedChip=function(){return this.isKind("ClockedChip")};comp_proto.prototype.isPlugin=function(){return this.isKind("Plugin")};comp_proto.prototype.isNodeContainer=function(){return(this.isKind("NodeNetwork")||this.isKind("NetWorld"))};comp_proto.prototype.isConverter=function(){return this.isTerm()||this.isInPin()||this.isOutPin()};function pl_proto(b,e,a,f,d){comp_proto.call(this,b,"Plugin");delete (this.exp);this.pluginType=e;this.pins=new Array();this.comps=new Array();this.preOrPost="post";for(var c=0;c<a.length;c++){this[a[c]]=new InPin(a[c]);this.pins.push(this[a[c]]);this.comps.push(this[a[c]])}for(var c=0;c<f.length;c++){this[f[c]]=new OutPin(f[c]);this.pins.push(this[f[c]]);this.comps.push(this[f[c]])}for(var c=0;c<d.length;c++){this[d[c]]=new Term(d[c]);this.comps.push(this[d[c]])}this.scopemaker=pscopemaker(this.comps,this);this.scope=new this.scopemaker(0)}pl_proto.prototype=Object.create(comp_proto.prototype);pl_proto.prototype.constructor=pl_proto;pl_proto.prototype.setCap=function(b){comp_proto.prototype.setCap.call(this,b);for(var a=0;a<this.comps.length;a++){this.comps[a].setCap(b)}};pl_proto.prototype.reset=function(a){this.scope=new this.scopemaker(a.current);this.clock=a};pl_proto.prototype.prereset=function(a){};pl_proto.prototype.strobe=function(a,b){this.scope.setTime(a)};pl_proto.prototype.update=function(a,b){};function Iterable(a,b){comp_proto.call(this,a,b);this.last="0.0";this.values=new Object();this.init=null}Iterable.prototype=Object.create(comp_proto.prototype);Iterable.prototype.constructor=Iterable;Iterable.prototype.value=function(a){return nsutil.interpolate(a,this.values)};Iterable.prototype.reset=function(a){this.values=new Object();this.store(a.lo,this.init.call(this.cap.scope))};Iterable.prototype.store=function(a,b){this.last=this.values[a]=b};Iterable.prototype.__defineGetter__("initial",function(){return this._exp});Iterable.prototype.__defineSetter__("initial",function(e){this._exp=e;if(typeof e=="string"||typeof e=="number"){eval(sprintf("function init(){return %s;}",e));this.init=init}else{if(typeof e=="function"){this.init=e}}});Iterable.prototype.show=function(){return this.values.toSource()};Iterable.prototype.clear=function(a){delete this.values[a]};Iterable.prototype.current=function(){return this.last};function LVariable(a){comp_proto.call(this,a,"LVariable");this._value=0}LVariable.prototype=Object.create(comp_proto.prototype);LVariable.prototype.constructor=LVariable;LVariable.prototype.__defineGetter__("value",function(){return function(){return this._value}});LVariable.prototype.__defineSetter__("value",function(a){this._value=a});LVariable.prototype.__defineGetter__("initial",function(){return this._exp});LVariable.prototype.__defineSetter__("initial",function(e){this._exp=e;if(typeof e=="string"||typeof e=="number"){eval(sprintf("function init(){return %s;}",e));this.init=init}else{if(typeof e=="function"){this.init=e}}});LVariable.prototype.reset=function(a){this.value=this.init.call(this.cap.scope)};function Stock(a){Iterable.call(this,a,"Stock");this.deriv="0.0";this.inFlow=null;this.outFlow=null;this.k0=this.k1=this.k2=this.k3=null}Stock.prototype=Object.create(Iterable.prototype);Stock.prototype.constructor=Stock;Stock.prototype.setInFlow=function(a){this.inFlow=a;a.outp=this;this.fixDeriv()};Stock.prototype.setOutFlow=function(a){this.outFlow=a;a.inp=this;this.fixDeriv()};Stock.prototype.update=function(a,b,c){this.store(a+b,this.values[a]+c)};Stock.prototype.getDeriv=function(){return this.doDeriv};Stock.prototype.current=function(){return this.last};Stock.prototype.fixDeriv=function(){if(this.inFlow==null&&this.outFlow==null){return}exp0=(this.inFlow)?this.inFlow.exp:null;exp1=(this.outFlow)?this.outFlow.exp:null;this.deriv=this.funcify(exp0,exp1)};Stock.prototype.__defineSetter__("deriv",function(exp){this._deriv=exp;if(typeof exp=="string"||typeof exp=="number"){eval(sprintf("function deriv(TIME){return %s;}",exp))}else{if(typeof exp=="function"){function deriv(t){return exp.call(this,t)}}}this.doDeriv=deriv});Stock.prototype.__defineGetter__("deriv",function(){return this._deriv});Stock.prototype.toString=function(){return sprintf("[Stock %s %s %s]",this.name,this.getName(this.inFlow),this.getName(this.outFlow))};Stock.prototype.funcify=function(pos,neg){if(pos!=null){if(neg==null){return pos}if(typeof pos=="function"){if(typeof neg=="function"){var ans=function(t){return pos.call(this,t,this.Super)-neg.call(this,t,this.Super)};ans.pos=pos;ans.neg=neg;return ans}if(typeof neg=="string"){eval(sprintf("function neg1(TIME, Super){return %s;}",neg));return function(t){return pos.call(this,t)-neg1.call(this,t)}}}if(typeof pos=="string"){if(typeof neg=="function"){eval(sprintf("function pos1(TIME, Super){return %s;}",pos));return function(t){return pos1.call(this,t,this.Super)-neg.call(this,t,this.Super)}}if(typeof neg=="string"){eval(sprintf("function pos1(TIME, Super){return %s;}",pos));eval(sprintf("function neg1(TIME, Super){return %s;}",neg));return function(t){return pos1.call(this,t,this.Super)-neg1.call(this,t,this.Super)}}}}if(typeof neg=="function"){return function(t){return -neg.call(this,t)}}if(typeof neg=="string"){eval(sprintf("function neg1(TIME){return -(%s);}",neg));return neg1}};function Sequence(a){Iterable.call(this,a,"Sequence");delete this._deriv;delete this.deriv;this.next=0}Sequence.prototype=Object.create(Iterable.prototype);Sequence.prototype.toString=function(){return sprintf("[Sequence %s]",this.name)};Sequence.prototype.__defineSetter__("next",function(exp){this._next=exp;if(typeof exp=="string"||typeof exp=="number"){eval(sprintf("function doNext(t){return %s;}",new String(exp).trim()))}else{if(typeof(exp)=="function"){function doNext(t){return exp.call(this)}}}this.doNext=doNext});Sequence.prototype.__defineGetter__("next",function(){return this._next});Sequence.prototype.update=function(a,b,c){this.store(a+b,c)};function Converter(a,b){comp_proto.call(this,a,b);this.cache=new Cachemaker(this.exp)}Converter.prototype=Object.create(comp_proto.prototype);Converter.prototype.__defineGetter__("exp",function(){return this._exp});Converter.prototype.__defineSetter__("exp",function(a){this._exp=a;this.cache=new Cachemaker(a);this.value=function(b){return this.cache.f(b,this.cap.scope)}});Converter.prototype.reset=function(a){this.cache.reset()};Converter.prototype.constructor=Converter;function Flow(b,c,a){Converter.call(this,b,"Flow");this.inp=c;this.outp=a;if(c){c.outFlow=this}if(a){a.inFlow=this}this._exp="0.0"}Flow.prototype=Object.create(Converter.prototype);Flow.prototype.constructor=Flow;Flow.prototype.__defineGetter__("exp",function(){return this._exp});Flow.prototype.__defineSetter__("exp",function(a){this._exp=a;this.cache=new Cachemaker(a);this.value=function(b){return this.cache.f(b,this.cap.scope)};if(this.inp){this.inp.fixDeriv()}if(this.outp){this.outp.fixDeriv()}});Flow.prototype.toString=function(){return sprintf("[Flow %s %s %s]",this.name,this.getName(this.inp),this.getName(this.outp))};function Term(a){Converter.call(this,a,"Term")}Term.prototype=Object.create(Converter.prototype);Term.prototype.toString=function(){return sprintf("[Term %s]",this.name)};Term.prototype.constructor=Term;function Slider(a){Converter.call(this,a,"Term");this.exp=function(){return +this.controls[a].value}}Slider.prototype=Object.create(Converter.prototype);Slider.prototype.toString=function(){return sprintf("[Slider %s]",this.name)};Slider.prototype.constructor=Slider;function Property(a){Converter.call(this,a,"Term")}Property.prototype=Object.create(Converter.prototype);Property.prototype.toString=function(){return sprintf("[Property %s]",this.name)};Property.prototype.constructor=Term;Property.prototype.__defineGetter__("exp",function(){return this._exp});Property.prototype.__defineSetter__("exp",function(a){this._exp=a;this.cache=new Cachemaker(a,"fixed");this.value=function(b){return this.cache.f(b,this.cap.scope)}});function InPin(a){Converter.call(this,a,"InPin")}InPin.prototype=Object.create(Converter.prototype);InPin.prototype.toString=function(){return sprintf("[InPin %s]",this.name)};InPin.prototype.constructor=InPin;function OutPin(a){Converter.call(this,a,"OutPin")}OutPin.prototype=Object.create(Converter.prototype);OutPin.prototype.toString=function(){return sprintf("[OutPin %s]",this.name)};OutPin.prototype.constructor=OutPin;function CodeChip(c,g,b,a,d){comp_proto.call(this,c,"CodeChip");this.method=("code" in g)?g.code:g;this.methodname=d;this.initial=b;this.inputs=a;this.cacheable=("cacheable" in g)?g.cacheable:true;this.preOrPost=("when" in g)?g.preOrPost:"post";var f;if(this.initial){var e=(typeof this.initial=="function")?this.initial():this.initial;f=this.method.apply(this.cap.scope,e)}else{f=this.method}this.value=this.memoize(f,this.inputs,this.cacheable)}CodeChip.prototype=Object.create(comp_proto.prototype);CodeChip.prototype.toString=function(){return sprintf("[CodeChip %s %s]",this.name,this.methodname)};CodeChip.prototype.reset=function(a){var c;if(this.initial){var b=(typeof this.initial=="function")?this.initial():this.initial;c=this.method.apply(this.cap.scope,b)}else{c=this.method}this.value=this.memoize(c,this.inputs,this.cacheable)};CodeChip.prototype.memoize=function(f,actuals,cacheable){var t0=-1;var cache=null;var actuals0=null;if(actuals!=null){actuals0=[];for(var i in actuals){actual=actuals[i];if(actual==null){actual="0"}if(typeof actual=="function"){actuals0.push(actual)}else{if(typeof actual=="string"||typeof actual=="number"){eval(sprintf("function aactual(){return %s}",new String(actual).trim()));actuals0.push(aactual)}}}}var g=function(scope){if(actuals!=null){var acts=new Array();for(var i in actuals0){acts[i]=actuals0[i].call(scope)}return f.apply(scope,acts)}else{return f.apply(scope,arguments)}};return function(t,scope){if(t0!=t||!cacheable){t0=t;cache=g(scope)}return cache}};function Command(name,preOrPost){comp_proto.call(this,name,"Command");var exp=this.exp;if(typeof exp=="string"){eval(sprintf("function block(t){%s}",new String(exp).trim()))}else{if(typeof exp=="function"){function block(t){exp.call(this,t)}}}this.value=block;this.preOrPost=(preOrPost)?preOrPost:"post";this.initCom=name.indexOf("initial")==0;this.finCom=name.indexOf("final")==0}Command.prototype=Object.create(comp_proto.prototype);Command.prototype.__defineGetter__("exp",function(){return this._exp});Command.prototype.__defineSetter__("exp",function(e){this._exp=e;if(typeof e=="string"){eval(sprintf("function block(t){%s}",new String(e).trim()));this.value=block}else{if(typeof e=="function"){this.value=e}}});Command.prototype.reset=function(a){};Command.prototype.toString=function(){return sprintf("[Command %s]",this.name)};Command.prototype.execute=function(a,b){this.value.call(b,a.current)};Command.prototype.constructor=Command;function Capsule(d,g,f,c){comp_proto.call(this,d,(f)?f:"Capsule");this.controls=c;this.components=new Object();for(var e=0;e<g.length;e++){this.components[g[e].name]=g[e]}this.clock=null;this.scope=null;this.Super=null;this.iterables=new Array();this.resetables=new Array();this.precoms=new Array();this.postcoms=new Array();this.preplugins=new Array();this.inpins=new Object();this.outpins=new Object();this.simulators=new Array();this.plugins=new Array();for(var a in this.components){var b=this.components[a];this[b.name]=b;b.setCap(this);if(b.isSimulator()){b.Super=this;this.simulators.push(b)}else{if(b.isIterable()){this.iterables.push(b)}else{if(b.isCommand()){if(b.preOrPost=="pre"){this.precoms.push(b)}if(b.preOrPost=="post"){this.postcoms.push(b)}}else{if(b.isConverter()||b.isCodeChip()||b.isLVariable()||(b.isSimulator()&&!b.isClockedChip())){this.resetables.push(b)}else{if(b.isPlugin()){if(b.preOrPost=="pre"){this.preplugins.push(b)}else{this.plugins.push(b)}}}}}}if(b.isInPin()){this.inpins[b.name]=b}else{if(b.isOutPin()){this.outpins[b.name]=b}}}this.preplugins=nsutil.sortPlugins(this.preplugins);this.plugins=nsutil.sortPlugins(this.plugins);this.scopemaker=scopemaker(this.components,this)}Capsule.prototype=Object.create(comp_proto.prototype);Capsule.prototype.constructor=Capsule;Capsule.prototype.curCap=null;Capsule.prototype.reset=function(b){var d=Capsule.curCap;Capsule.curCap=this;this.clock=b;for(var a=0;a<this.plugins.length;a++){this.plugins[a].prereset(b)}this.scope=new this.scopemaker(b.current);for(var c=0;c<this.simulators.length;c++){if(this.simulators[c].isClockedChip()){continue}this.simulators[c].reset(b)}for(var a=0;a<this.resetables.length;a++){this.resetables[a].reset(b)}for(var a=0;a<this.iterables.length;a++){this.iterables[a].reset(b)}for(var a=0;a<this.preplugins.length;a++){this.preplugins[a].reset(b,this.scope)}for(var a=0;a<this.plugins.length;a++){this.plugins[a].reset(b,this.scope)}for(var c=0;c<this.simulators.length;c++){if(this.simulators[c].isNodeContainer()){this.simulators[c].connectNodes()}}Capsule.curCap=d};Capsule.prototype.iterate=function(d,e,c){this.scope.setTime(d);var f=Capsule.curCap;Capsule.curCap=this;if(this.clock.method=="Euler"||(this.clock.method=="RK4"&&e=="k0")){for(var b=0;b<this.precoms.length;b++){if(this.precoms[b].initCom&&!this.clock.isFirst()){continue}if(this.precoms[b].finCom&&!this.clock.isLast()){continue}this.precoms[b].execute(this.clock,this.scope)}for(var a=0;a<this.preplugins.length;a++){this.preplugins[a].strobe(this.clock.current,this.scope)}for(var a=0;a<this.preplugins.length;a++){this.preplugins[a].update(this.clock.current,this.scope)}}var g=function(){for(var h=0;h<this.iterables.length;h++){integrator(this.clock.method,this.iterables[h],this.clock.current,this.clock.dt,this.scope,e)}Capsule.curCap=f;c()}.bind(this);kloop(this.simulators,function(h,k){h.iterate(d,e,k,this.clock)}.bind(this),g)};Capsule.prototype.strobe=function(){return this.iterate.apply(this,arguments)};Capsule.prototype.toString=function(){return sprintf("[Capsule %s %s]",this.name,Object.keys(this.components))};Capsule.prototype.postProcess=function(b){this.scope.setTime(b);for(var c=0;c<this.simulators.length;c++){if(this.simulators[c].isClockedChip()){continue}this.simulators[c].postProcess(b)}for(var a=0;a<this.plugins.length;a++){this.plugins[a].strobe(this.clock.current,this.scope)}for(var a=0;a<this.plugins.length;a++){this.plugins[a].update(this.clock.current,this.scope)}for(var a=0;a<this.postcoms.length;a++){if(this.postcoms[a].initCom&&!this.clock.isFirst()){continue}if(this.postcoms[a].finCom&&!this.clock.isLast()){continue}this.postcoms[a].execute(this.clock,this.scope)}};Capsule.prototype.terminate=function(){for(var a=0;a<this.postcoms.length;a++){if(this.postcoms[a].finCom){this.postcoms[a].execute(this.clock,this.scope)}}};Capsule.prototype.FLIP=function(a){return Math.random()<a};Capsule.prototype.POISSON=function(c){var a=Math.exp(-c);var b=0;var d=1;do{b++;d=Math.random()*d}while(d>a);return b-1};function ClockedChip(a,b,c){Capsule.call(this,a,b,"ClockedChip");if(Array.isArray(c)){this.clock=Object.create(Clock.prototype);Clock.apply(this.clock,c)}else{this.clock=new Clock(c.lo,c.hi,c.dt,c.method)}}ClockedChip.prototype=Object.create(Capsule.prototype);ClockedChip.prototype.strobe=function(){return Capsule.prototype.iterate.apply(this,arguments)};ClockedChip.prototype.iterate=function(c,d,a,b){b.halt();this.clock.reset(this);this.clock.run(function(){a();b.restart()})};ClockedChip.prototype.toString=function(){return sprintf("[ClockedChip %s %s]",this.name,Object.keys(this.components))};function AgentVector(c,d,b,e,f,a){comp_proto.call(this,c,"AgentVector");this.recycle=[];this.capgen=d;this.counter=b;this.count=(b==null)?0:(typeof this.counter=="function")?this.counter():this.counter;this.rows=e;this.cols=f;this.lastId=0;this.inpins={Init_Count:new InPin("Init_Count")};this.inpinExps=new Object();this.simworld=a;this.generate();this.pinsDone=false;this.inPinSetup();this.outPinSetup();this.births={};this.deaths={};this.vscopes=[];this.__defineGetter__("AData",function(){return this.vscopes})}AgentVector.prototype=Object.create(comp_proto.prototype);AgentVector.prototype.constructor=AgentVector;AgentVector.prototype.strobe=function(){return this.iterate.apply(this,arguments)};AgentVector.prototype.setCap=function(c){comp_proto.prototype.setCap.call(this,c);this.Super=c;var a=this.vector;for(var b=0;b<a.length;b++){a[b].setCap(c);a[b].Super=c}};AgentVector.prototype.generate=function(a){this.vector=new Array();var d=(a)?Object.keys(a):null;for(var c=0;c<this.count;c++){var b=this.populateOne(c);this.vector.push(b);if(a){var e=a[d[c]];b.ix=e.ix;b.iy=e.iy;b.itheta=e.itheta}}this.baseAgentSet=new Array();for(var c in this.vector){this.baseAgentSet[c]=this.vector[c]}this.lastId=this.count};AgentVector.prototype.populateOne=function(b,c){var a;if(this.recycle.length>0){a=this.recycle.pop();a.clean();Agent.call(a,a.name,a.components,b)}else{a=this.capgen(b,Agent)}a.agentvector=this;a.Super=this;if(this.simworld){a.simworld=this.simworld;a.mycell=null}return a};AgentVector.prototype.regenerate=function(a){if(typeof a=="number"){this.count=a;a=undefined}else{this.count=Object.keys(a).length}this.generate(a);if(this.count==0){return}if(!this.pinsDone){var c=this.vector[0];var d=new Object();for(var b in c.inpins){d[b]=this[b]}this.inPinSetup();for(var b in d){this[b]=d[b]}this.outPinSetup()}else{for(var b in this.inpinExps){this.inPinVectorFix(this.inpinExps[b],b)}}};AgentVector.prototype.createAgent=function(a,d){var b=this.lastId++;var c=this.populateOne(b);c.parent=d.self;c.setCap(this.cap);this.initialize(c,a,d);this.births[b]=c;return b};AgentVector.prototype.killAgent=function(a){a.zombie=true;this.deaths[a.id]=a};AgentVector.prototype.toString=function(){return sprintf("[AgentVector %s %s]",this.name,this.capgen.name)};AgentVector.prototype.MYCELL=function(a){return this.vector[+a].mycell.scope};AgentVector.prototype.X=function(a){return(this.vector[+a])?this.vector[+a].x:null};AgentVector.prototype.Y=function(a){return(this.vector[+a])?this.vector[+a].y:null};AgentVector.prototype.THETA=function(a){return(this.vector[+a])?this.vector[+a].theta:null};AgentVector.prototype.AGENTS=function(a){return(this.vector[+a])?this.vector[+a].scope:null};AgentVector.prototype.__defineGetter__("Ids",function(){return Object.keys(this.vector)});AgentVector.prototype.__defineGetter__("Agentcount",function(){return Object.keys(this.vector).length});AgentVector.prototype.inPinSetup=function(){if(this.vector.length==0){return}var b=this.vector[0];for(var a in b.inpins){this.__defineGetter__(a,(function(c){return function(){return this.inpinExps[c]}})(a));this.__defineSetter__(a,(function(c){return function(d){this.inpinExps[c]=d;this.inPinVectorFix(d,c)}})(a))}this.pinsDone=true};AgentVector.prototype.inPinVectorFix=function(b,a){for(j in this.vector){this.inPinFix(b,a,this.vector[j])}};AgentVector.prototype.inPinFix=function(c,a,b){var d=b.id;if(typeof c=="string"||typeof c=="number"){b.inpins[a].exp=sprintf("(function(myId){return %s;}).call(this, %d)",new String(c).trim(),d)}else{if(typeof c=="function"){b.inpins[a].exp=function(){return c.call(this,this.id)}}}};AgentVector.prototype.outPinSetup=function(){if(this.vector.length==0){return}var b=this.vector[0];for(var a in b.outpins){this.__defineGetter__(a,(function(c){return function(){return function(d){return this.vector[d].scope[c]}.bind(this)}})(a))}};AgentVector.prototype.initialize=function(d,b,e){if(!b){b=e}d.ix=(b.x!=undefined)?b.x:e.x;d.iy=(b.y!=undefined)?b.y:e.y;d.itheta=(b.theta!=undefined)?b.theta:e.theta;d.x=d.ix;d.y=d.iy;d.theta=d.itheta;for(var c in b){var f=b[c];if(d.components.hasOwnProperty(c)){var a=d.components[c];if(a.isIterable()||a.isLVariable()){a.initial=f}else{a.exp=f}}}for(var c in this.inpinExps){this.inPinFix(this.inpinExps[c],c,d)}};AgentVector.prototype.iterate=function(c,d,a){for(var b in this.changes){this.changes[b]=[]}kloop(this.vector,function(e,f){e.iterate(c,d,f)},a)};function kloop(a,d,b){var c=Object.keys(a);var e=function(){if(c.length==0){b()}else{var f=c.shift();d(a[f],e,f)}};e()}AgentVector.prototype.terminate=function(){for(var a in this.vector){this.vector[a].terminate()}};AgentVector.prototype.postProcess=function(c){this.scope.setTime(c);for(var b in this.vector){this.vector[b].postProcess(c)}for(var b in this.births){var a=this.births[+b];this.vector[+b]=a;a.reset(this.clock)}for(var b in this.deaths){if(this.vector[+b].id>=this.count){this.recycle.push(this.vector[+b])}delete this.vector[+b]}this.changes._births_=Object.keys(this.births);this.changes._deaths_=Object.keys(this.deaths);this.deaths={};this.births={}};AgentVector.prototype.reset=function(d){delete this.vector;delete this.recycle;this.clock=d;this.vector=new Array();this.recycle=new Array();this.scopemaker=scopemaker([],this);this.scope=new this.scopemaker(d.current);var f=this.count;var e=this.scope.Init_Count;if(e!=null){this.count=(typeof e=="function")?e.call(this.scope):e}else{if(this.counter!=null){this.count=(typeof this.counter=="function")?this.counter().call(this.scope):this.counter}}if(f==this.count){for(var c in this.baseAgentSet){this.vector[c]=this.baseAgentSet[c];this.vector[c].clean()}}else{this.recycle=this.baseAgentSet;this.regenerate(this.count);this.lastId=this.count}this.changes=new Object();this.changes.location=[];this.births={};this.deaths={};this.moved=new Array();if(this.vector.length==0){return}this.changes._births_=[];this.changes._deaths_=[];for(var a in this.vector[0].outDataNames){var b=this.vector[0].outDataNames[a];if(b=="x"||b=="y"){continue}this.changes[b]=[]}this.vscopes=[];for(var c in this.vector){this.vector[c].reset(d);this.vscopes[c]=this.vector[c].scope}};AgentVector.prototype.register=function(b,a){this.changes[b].push(a.id);if(b=="location"){this.moved.push(a)}};AgentVector.prototype.putAgentInCell=function(b,a){b.mycell=a};AgentVector.prototype.INBOUNDS=function(e,d){var c=nsutil.coordsOrNum(e,d);var b=c[0];var f=c[1];return(f>=0&&f<this.rows&&b>=0&&b<this.cols)};function Agent(a,b,c){Capsule.call(this,a,b,"Agent");this.kind="Agent";this.id=c;this.x=0;this.y=0;this.theta=0;this.zombie=false;this.parent=null;this.birth=0;this.fresh=true;this.outDataNames=["x","y"].concat(Object.keys(this.outpins))}Agent.prototype=Object.create(Capsule.prototype);Agent.prototype.constructor=Agent;Agent.prototype.toString=function(){return sprintf("[Agent %s %s]",this.name,Object.keys(this.components))};Agent.prototype.clean=function(){this.ix=null;this.iy=null};Agent.prototype.reset=function(d){Capsule.prototype.reset.call(this,d);this.birth=this.clock.current;this.outPinData=new Object();if(this.agentvector.simworld){this.mycell=null}this.x=(this.ix)?this.ix:(this.init_x)?this.init_x.value(d.lo):0;this.y=(this.iy)?this.iy:(this.init_y)?this.init_y.value(d.lo):0;this.theta=(this.itheta)?this.itheta:(this.init_theta)?this.init_theta.value(d.lo):0;this.ix=this.x;this.iy=this.y;this.itheta=this.theta;this.zombie=false;var b=false;for(var a in this.outDataNames){var c=this.outDataNames[a];var e=c;this.outPinData[c]=this.scope[c];if(c=="x"||c=="y"){if(b){continue}b=true;e="location"}this.agentvector.register(e,this)}};Agent.prototype.iterate=function(b,c,a){if(this.zombie){a()}Capsule.prototype.iterate.call(this,b,c,a)};Agent.prototype.postProcess=function(d,e){Capsule.prototype.postProcess.call(this,d,e);var b=false;for(var a in this.outDataNames){var c=this.outDataNames[a];var f=c;if(this.outPinData[c]!=this.scope[c]){this.outPinData[c]=this.scope[c];if(c=="x"||c=="y"){if(b){continue}b=true;f="location"}else{f=c}this.agentvector.register(f,this)}}};Agent.prototype.MYCELL=function(a){return(arguments.length==0)?this.mycell.scope:this.agentvector.MYCELL(a).scope};Agent.prototype.MOVETO=function(a,b){if(a==this.self.x&&b==this.self.y){return}var c=nsutil.coordsOrNum(b,a);b=c[0];a=c[1];this.self.x=nsutil.wrap(a,this.agentvector.cols);this.self.y=nsutil.wrap(b,this.agentvector.rows);this.self.wrapped=(this.x!=a)||(this.y!=b)};Agent.prototype.MOVEPLUS=function(a,e){var d=nsutil.coordsOrNum(e,a);e=d[0];a=d[1];var b=this.self.x+a;var c=this.self.y+e;this.self.x=nsutil.wrap(b,this.agentvector.cols);this.self.y=nsutil.wrap(c,this.agentvector.rows);this.self.wrapped=(this.x!=b)||(this.y!=c)};Agent.prototype.MOVEPLUSR=function(c){var a=this.self.x+c*Math.cos(this.theta);var b=this.self.y+c*Math.sin(this.theta);this.self.x=nsutil.wrap(a,this.agentvector.cols);this.self.y=nsutil.wrap(b,this.agentvector.rows);this.self.wrapped=(this.x!=a)||(this.y!=b)};Agent.prototype.NEWTHETA=function(a){this.self.theta=nsutil.math.normalize(a)};Agent.prototype.CELL=function(c,b){var a=nsutil.coordsOrNum(c,b);return this.agentvector.simworld.cellmatrix.matrix[Math.floor(a[0])][Math.floor(a[1])].scope};Agent.prototype.AGENTS=function(a){return this.agentvector.vector[a].scope};Agent.prototype.AGENTBLOCK=function(f){var e=this.mycell.BLOCK(f);var a=new Array();for(var b in e){var d=this.CELL(e[b]).myagents;var c=Object.keys(d);for(var g in c){a.push(d[c[g]].scope)}}return a};Agent.prototype.DISTANCE_TO=function(b){var a=(typeof b=="object")?b:this.agentvector.vector[b];if(a==null){return infinity}return nsutil.math.distance(this,a)};Agent.prototype.IN_RADIUS=function(b){var a=new Array();var c;for(var d in this.agentvector.vector){if(d==this.id){continue}if((c=this.DISTANCE_TO(d))<=b){a.push({id:d,distance:c})}}a.sort(function(e,f){return e.distance-f.distance});return a};Agent.prototype.BOUNCE=function(b){var a=this.self.x;var g=this.self.y;var c=nsutil.math.normalize(b);var d=this.agentvector.rows;var e=this.agentvector.cols;var f=(a>1&&a<e-1&&g>1&&g<d-1)?c:(((a<=1)&&(c>nsutil.math.pio2||c<nsutil.math.mpio2))||(a>=e-1&&c>nsutil.math.mpio2&&c<nsutil.math.pio2))?nsutil.math.normalize(nsutil.math.pi-c):((g<=2&&c>=nsutil.math.mpi&&c<=0)||(g>=d-1&&c>=0&&c<=nsutil.math.pi))?nsutil.math.normalize(-c):c;return f};Agent.prototype.CREATE=function(b,e){if(e==0){return null}if(e==undefined||e==1){var c=this.agentvector.createAgent(b,this);return c}var a=[];for(var d=0;d<e;d++){a.push(this.agentvector.createAgent(b,this))}return a};Agent.prototype.KILL=function(a){if(this.agentvector.vector[a]){this.agentvector.killAgent(this.agentvector.vector[a])}};Agent.prototype.SOME_AGENT=function(b,c,d){return b.some(function(a){return a[c]==d})};AgentVector.prototype.X=function(a){return(this.vector[+a])?this.vector[+a].x:null};Agent.prototype.RANDOM_MOVE=function(){var c=this.self.x;var a=this.self.y;if(c==undefined||a==undefined){return{x:x,y:y}}var h=c;var g=a;for(;;){var f=Math.random();var e=(f<0.33333)?-1:(f<0.66666)?0:1;var d=Math.random();var b=(d<0.33333)?-1:(d<0.66666)?0:1;h=c+e;g=a+b;if(this.agentvector.INBOUNDS(h,g)){return new Object({x:h,y:g})}}};Agent.prototype.__defineGetter__("rows",function(){return this.agentvector.rows});Agent.prototype.__defineGetter__("cols",function(){return this.agentvector.rows});Agent.prototype.__defineGetter__("mycoords",function(){return{col:Math.floor(this.self.x),row:Math.floor(this.self.y)}});Agent.prototype.__defineGetter__("Location",function(){return{x:this.self.x,y:this.self.y,theta:this.self.theta}});Agent.prototype.__defineGetter__("Agentcount",function(){return this.agentvector.Agentcount});function CellMatrix(c,f,g,h,a){comp_proto.call(this,c,"CellMatrix");this.capgen=f;this.rows=g;this.cols=h;this.matrix=new Array();this.cellsById=new Object();this.inpinExps=new Object();this.simworld=a;for(var e=0;e<this.rows;e++){this.matrix[e]=new Array();for(var b=0;b<this.cols;b++){var d=f(e,b,Cell);d.cellmatrix=this;d.Super=this;d.Coords={row:e,col:b};this.matrix[e].push(d);this.cellsById[d.id]=d;if(this.simworld){d.myagents=new Object()}}}this.inPinSetup();this.outPinSetup();if(a){this.simworld=a}}CellMatrix.prototype=Object.create(comp_proto.prototype);CellMatrix.prototype.constructor=CellMatrix;CellMatrix.prototype.strobe=function(){return this.iterate.apply(this,arguments)};CellMatrix.prototype.toString=function(){return sprintf("[CellMatrix %s %s]",this.name,this.capgen.name)};CellMatrix.prototype.setCap=function(d){comp_proto.prototype.setCap.call(this,d);this.Super=d;var a=this.matrix;for(var c=0;c<a.length;c++){for(var b=0;b<a[c].length;b++){a[c][b].setCap(d);a[c][b].Super=d}}};CellMatrix.prototype.CELLS=function(d,b){if(arguments.length==0){var c=new Array();var a=this.matrix;for(var d=0;d<a.length;d++){c[d]=new Array();for(var b=0;b<a[d].length;b++){c[d][b]=a[d][b].scope}}return c}if(b==undefined){return this.cellsById[d].scope}return this.matrix[d][b].scope};var CELL=function(b,a){return Capsule.curCap.CELL(b,a)};CellMatrix.prototype.CELL=CellMatrix.prototype.CELLS;CellMatrix.prototype.inPinSetup=function(){if(this.matrix.length==0){return}var b=this.matrix[0][0];for(var a in b.inpins){this.__defineGetter__(a,(function(c){return function(){return this.inpinExps[c]}})(a));this.__defineSetter__(a,(function(c){return function(d){this.inpinExps[c]=d;this.inPinNodesFix(d,c)}})(a))}};CellMatrix.prototype.inPinNodesFix=function(b,a){for(i in this.matrix){for(j in this.matrix[i]){this.inPinFix(b,a,this.matrix[i][j])}}};CellMatrix.prototype.inPinFix=function(c,a,b){var d=b.id;if(typeof c=="string"||typeof c=="number"){b.inpins[a].exp=sprintf("(function(coords){return %s;}).call(this, {row: %d, col:%d})",new String(c).trim(),i,j)}else{if(typeof c=="function"){b.inpins[a].exp=function(){return c.call(this,{row:this.row,col:this.col})}}}};CellMatrix.prototype.outPinSetup=function(){if(this.matrix.length==0){return}var b=this.matrix[0][0];for(var a in b.outpins){this.__defineGetter__(a,(function(c){return function(){return function(e,d){return this.matrix[e][d].scope[c]}.bind(this)}})(a))}};CellMatrix.prototype.iterate=function(f,g,b){for(var d in this.changes){this.changes[d]=[]}var a=this.matrix;var h=function(){};for(var e=0;e<a.length;e++){for(var c=0;c<a[e].length;c++){a[e][c].iterate(f,g,h)}}b()};function kloop2(a,e,b){var g=Object.keys(a);if(g.length==0){b()}else{var d=[];var c=null;var h=function(){if(d.length==0){if(g.length==0){b()}else{c=g.shift();d=Object.keys(a[c]);var f=d.shift();e(a[c][f],h)}}else{var f=d.shift();e(a[c][f],h,c,f)}};h()}}CellMatrix.prototype.terminate=function(){for(i in this.matrix){for(j in this.matrix[i]){this.matrix[i][j].terminate()}}};CellMatrix.prototype.postProcess=function(a){this.scope.setTime(a);for(i in this.matrix){for(j in this.matrix[i]){this.matrix[i][j].postProcess(a)}}};CellMatrix.prototype.reset=function(b){this.clock=b;this.scopemaker=scopemaker([],this);this.scope=new this.scopemaker(b.current);this.changes=new Object();if(this.matrix.length==0){return}for(var a in this.matrix[0][0].outpins){this.changes[a]=[]}for(i in this.matrix){for(j in this.matrix[i]){this.matrix[i][j].reset(b)}}};CellMatrix.prototype.addAgentToCell=function(b){var a=this.matrix[Math.floor(b.y)][Math.floor(b.x)];a.myagents[b.id]=b;return a};CellMatrix.prototype.deleteAgentFromCell=function(b){var a=b.mycell;delete a.myagents[b.id]};function Cell(b,c,d,a){Capsule.call(this,b,c,"Cell");this.row=d;this.col=a;this.id=sprintf("C%d:%d",d,a)}Cell.prototype=Object.create(Capsule.prototype);Cell.prototype.toString=function(){return sprintf("[Cell %s %s]",this.name,Object.keys(this.components))};Cell.prototype.constructor=Cell;Cell.prototype.reset=function(b){Capsule.prototype.reset.call(this,b);this.outPinData=new Object();if(this.cellmatrix.simworld){this.myagents=new Object()}for(var a in this.outpins){this.outPinData[a]=this.scope[a];this.cellmatrix.changes[a].push(this.id)}};Cell.prototype.postProcess=function(b,c){Capsule.prototype.postProcess.call(this,b,c);for(var a in this.outpins){if(this.outPinData[a]!=this.scope[a]){this.outPinData[a]=this.scope[a];this.cellmatrix.changes[a].push(this.id)}}};Cell.prototype.CELLS=function(d,b){var c=new Array();var a=this.cellmatrix.matrix;for(var d=0;d<a.length;d++){c[d]=new Array();for(var b=0;b<a[d].length;b++){c[d][b]=a[d][b].scope}}return c};Cell.prototype.CELL=function(c,b){var a=nsutil.coordsOrNum(c,b);return this.cellmatrix.matrix[a[0]][a[1]].scope};Cell.prototype.CELL_VALUE=function(c,b,d){var a=nsutil.coordsOrNum(c,b);return this.cellmatrix.matrix[a[0]][a[1]].scope[d]};Cell.prototype.MYAGENTS=function(b,a){var c=this;if(arguments.length==0){return Object.keys(this.myagents).map(function(d){return c.myagents[d].scope})}return this.CELL(b,a).MYAGENTS()};Cell.prototype.MYAGENT_COUNT=function(b,a){if(arguments.length==0){return Object.keys(this.myagents).length}return this.CELL(b,a).MYAGENT_COUNT()};Cell.prototype.RING=function(d){var a=new Array();if(this.row-d>0){var c=this.row-d;for(var b=this.col-d;b<=this.col+d;b++){if(b<0||b>=this.cols){continue}a.push({row:c,col:b})}}if(this.col+d<this.cols){var b=this.col+d;for(var c=this.row-d+1;c<=this.row+d;c++){if(c<0||c>=this.rows){continue}a.push({row:c,col:b})}}if(this.row+d<this.rows){var c=this.row+d;for(var b=this.col+d-1;b>=this.col-d;b--){if(b<0||b>=this.cols){continue}a.push({row:c,col:b})}}if(this.col-d>=0){var b=this.col-d;for(var c=this.row+d-1;c>this.row-d;c--){if(c<0||c>=this.rows){continue}a.push({row:c,col:b})}}return a};Cell.prototype.WRING=function(d){var a=new Array();var c=nsutil.wrap(this.row-d,this.rows);for(var b=this.col-d;b<=this.col+d;b++){a.push({row:c,col:nsutil.wrap(b,this.cols)})}var b=nsutil.wrap(this.col+d,this.cols);for(var c=this.row-d+1;c<=this.row+d;c++){a.push({row:nsutil.wrap(c,this.rows),col:b})}c=nsutil.wrap(this.row+d,this.rows);for(var b=this.col+d-1;b>=this.col-d;b--){a.push({row:c,col:nsutil.wrap(b,this.cols)})}b=nsutil.wrap(this.col-d,this.cols);for(var c=this.row+d-1;c>this.row-d;c--){a.push({row:nsutil.wrap(c,this.rows),col:b})}return a};Cell.prototype.BLOCK=function(d){var a=new Array();for(var c=this.row-d;c<=this.row+d;c++){for(var b=this.col-d;b<=this.col+d;b++){if(c<0||c>=this.rows||b<0||b>=this.cols){continue}a.push({row:c,col:b})}}return a};Cell.prototype.WBLOCK=function(d){var a=new Array();for(var c=this.row-d;c<=this.row+d;c++){for(var b=this.col-d;b<=this.col+d;b++){a.push({row:c,col:b})}}return a};Cell.prototype.__defineGetter__("coords",function(){return{row:this.row,col:this.col}});Cell.prototype.__defineGetter__("rows",function(){return this.cellmatrix.rows});Cell.prototype.__defineGetter__("cols",function(){return this.cellmatrix.cols});function NodeNetwork(a,e,g,d,f){comp_proto.call(this,a,"NodeNetwork");this.capgen=e;this.nconnect=d;this.nodes=new Array();this.inpinExps=new Object();this.networld=f;this.count=g;this.connexions=new Array();for(var c=0;c<this.count;c++){var b=e(c,Node);b.nodenetwork=this;b.Super=this;b.id=c;this.nodes[c]=b;if(this.networld){b.myagents=new Object()}}this.inPinSetup();this.outPinSetup();this.fstTime=true;if(f){this.networld=f}}NodeNetwork.prototype=Object.create(comp_proto.prototype);NodeNetwork.prototype.constructor=NodeNetwork;NodeNetwork.prototype.setCap=function(c){comp_proto.prototype.setCap.call(this,c);this.Super=c;var a=this.nodes;for(var b=0;b<a.length;b++){a[b].setCap(c);a[b].Super=c}};NodeNetwork.prototype.strobe=function(){return this.iterate.apply(this,arguments)};NodeNetwork.prototype.toString=function(){return sprintf("[NodeNetwork %s %s]",this.name,this.capgen.name)};NodeNetwork.prototype.NODES=function(a){return this.nodes[a].scope};NodeNetwork.prototype.CONNECTION=function(b,a){return this.nodes[b].connexions_out[a]};NodeNetwork.prototype.CONNECTIONS_OUT=function(a){return this.nodes[i].connexions_out};NodeNetwork.prototype.CONNECTIONS_IN=function(a){return this.nodes[i].connexions_in};NodeNetwork.prototype.OUTFLOW=function(a){return this.nodes[i].outStrength};NodeNetwork.prototype.INFLOW=function(a){return this.nodes[i].inStrength};NodeNetwork.prototype.inPinSetup=function(){if(this.nodes.length==0){return}var b=this.nodes[0];for(var a in b.inpins){this.__defineGetter__(a,(function(c){return function(){return this.inpinExps[c]}})(a));this.__defineSetter__(a,(function(c){return function(d){this.inpinExps[c]=d;this.inPinNodesFix(d,c)}})(a))}};NodeNetwork.prototype.inPinNodesFix=function(b,a){for(j in this.nodes){this.inPinFix(b,a,this.nodes[j])}};NodeNetwork.prototype.inPinFix=function(c,a,b){var d=b.id;if(typeof c=="string"||typeof c=="number"){b.inpins[a].exp=sprintf("(function(myId){return %s;}).call(this, %d)",new String(c).trim(),d)}else{if(typeof c=="function"){b.inpins[a].exp=function(){return c.call(this,this.id)}}}};NodeNetwork.prototype.outPinSetup=function(){if(this.nodes.length==0){return}var b=this.nodes[0];for(var a in b.outpins){this.__defineGetter__(a,(function(c){return function(){var d=this;return function(e){return d.nodes[e].scope[c]}.bind(this)}})(a))}};NodeNetwork.prototype.iterate=function(c,d,a){for(var b in this.changes){this.changes[b]=[]}kloop(this.nodes,function(e,f){e.iterate(c,d,f)},a)};NodeNetwork.prototype.terminate=function(){for(i in this.nodes){this.nodes[i].terminate()}};NodeNetwork.prototype.postProcess=function(a){this.scope.setTime(a);for(i in this.nodes){this.nodes[i].postProcess(a)}};NodeNetwork.prototype.reset=function(b){this.clock=b;this.scopemaker=scopemaker([],this);this.scope=new this.scopemaker(b.current);this.changes=new Object();if(this.nodes.length==0){return}for(var a in this.nodes[0].outpins){this.changes[a]=[]}for(i in this.nodes){Capsule.prototype.reset.call(this.nodes[i],b)}for(i in this.nodes){this.nodes[i].reset(b)}};NodeNetwork.prototype.connectNodes=function(){if(!this.fstTime){return}this.fstTime=false;for(i in this.nodes){var a=this.nodes[i];a.connexions_in=new Array();a.connexions_out=new Array();a.outStrength=0;a.inStrength=0}this.connexions=new Array();for(i in this.nodes){this.nodes[i].connectUp(this.nodes,this.nconnect,this.connexions)}for(i in this.nodes){this.nodes[i].normalizeConnexions()}};NodeNetwork.prototype.addAgentToNode=function(a){var b=this.nodes[Math.floor(a.mynode)];b.myagents[a.id]=a;return b};NodeNetwork.prototype.deleteAgentFromNode=function(a){var b=a.mynode;delete b.myagents[a.id]};function Node(a,b,c){Capsule.call(this,a,b,"Node");this.id=c;this.connexions_in=new Array();this.connexions_out=new Array();this.outStrength=0;this.inStrength=0}Node.prototype=Object.create(Capsule.prototype);Node.prototype.toString=function(){return sprintf("[Node %s %s]",this.name,Object.keys(this.components))};Node.prototype.constructor=Node;Node.prototype.reset=function(b){this.outPinData=new Object();if(this.nodenetwork.networld){this.myagents=new Object()}for(var a in this.outpins){this.outPinData[a]=this.scope[a];this.nodenetwork.changes[a].push(this.id)}};Node.prototype.postProcess=function(b,c){Capsule.prototype.postProcess.call(this,b,c);for(var a in this.outpins){if(this.outPinData[a]!=this.scope[a]){this.outPinData[a]=this.scope[a];this.nodenetwork.changes[a].push(this.id)}}};Node.prototype.normalizeConnexions=function(){var b=this.outStrength;for(var c in this.connexions_out){var a=this.connexions_out[c];a.n_strength=a.strength/b}};Node.prototype.connectUp=function(b,d,g){for(var c in b){var a=b[c];if(a.id==this.id){continue}var f=d.call(this.scope,this.id,a.id);if(f==0){continue}var e={source:this.id,target:a.id,strength:f};g.push(e);this.connexions_out[a.id]=e;this.outStrength+=f;a.connexions_in[this.id]=e;a.inStrength+=f}};Node.prototype.NODE=function(a){return this.nodenetwork.nodes[a].scope};Node.prototype.MYAGENTS=function(a){var b=this;if(arguments.length==0){return Object.keys(this.myagents).map(function(c){return b.myagents[c].scope})}return this.NODE(a).MYAGENTS()};Node.prototype.MYAGENT_COUNT=function(a){if(arguments.length==0){return Object.keys(this.myagents).length}return this.NODE(a).MYAGENT_COUNT()};Node.prototype.NODES=function(a){return this.nodenetwork.NODES(a)};Node.prototype.CONNECTION=function(b,a){return this.nodenetwork.CONNECTION(b,a)};Node.prototype.CONNECTIONS_OUT=function(a){return this.nodenetwork.CONNECTIONS_OUT(a)};Node.prototype.CONNECTIONS_IN=function(a){return this.nodenetwork.CONNECTIONS_IN(a)};Node.prototype.OUTFLOW=function(a){return this.nodenetwork.OUTFLOW(a)};Node.prototype.INFLOW=function(a){return this.nodenetwork.INFLOW(a)};function Simworld(b,a,f,d,e,c){comp_proto.call(this,b,"Simworld");this.agentgen=a;this.cellgen=f;this.rows=d;this.cols=e;this.count=c;this.agentvector=new AgentVector(b+"_agent",a,c,d,e,this);this.cellmatrix=new CellMatrix(b+"_cell",f,d,e,this);this.agentvector.Super=this;this.cellmatrix.Super=this}Simworld.prototype=Object.create(comp_proto.prototype);Simworld.prototype.constructor=Simworld;Simworld.prototype.setCap=function(a){comp_proto.prototype.setCap.call(this,a);this.Super=a;this.cellmatrix.setCap(a);this.agentvector.setCap(a)};Simworld.prototype.strobe=function(){return this.iterate.apply(this,arguments)};Simworld.prototype.toString=function(){return sprintf("[Simworld %s %s %s]",this.name,this.agentgen.name,this.cellgen.name)};Simworld.prototype.MYCELL=function(a){return this.agentvector.vector[a].mycell.scope};Simworld.prototype.MYAGENTS=function(b,a){return this.cellmatrix.matrix[b][a].MYAGENTS()};Simworld.prototype.reset=function(c){this.scopemaker=scopemaker([],this);this.scope=new this.scopemaker(c.current);this.agentvector.reset(c);this.cellmatrix.reset(c);for(var b in this.agentvector.moved){var d=this.agentvector.moved[b];var a=this.cellmatrix.addAgentToCell(d);this.agentvector.putAgentInCell(d,a)}this.agentvector.moved=new Array()};Simworld.prototype.iterate=function(b,c,a){this.agentvector.iterate(b,c,function(){this.cellmatrix.iterate(b,c,a)}.bind(this))};CellMatrix.prototype.terminate=function(){this.agentvector.terminate();this.cellmatrix.terminate()};Simworld.prototype.postProcess=function(b){this.scope.setTime(b);this.agentvector.postProcess(b);this.cellmatrix.postProcess(b);for(var a in this.agentvector.moved){var c=this.agentvector.moved[a];this.cellmatrix.deleteAgentFromCell(c);var d=this.cellmatrix.addAgentToCell(c);this.agentvector.putAgentInCell(c,d)}this.agentvector.moved=new Array()};Simworld.prototype.__defineGetter__("AGENTS",function(){return this.agentvector.AGENTS});Simworld.prototype.__defineGetter__("CELLS",function(){return this.agentvector.CELLS});function Clock(b,a,c,d){this.lo=b;this.hi=this.getArg(a);this.dt=(c)?c:1;this.current=b;this.flag=false;this.newspeed=false;this.domultirun=false;this.speed=0;this.method=(d)?d:"Euler";this.cleanup=function(){};this.isRunAll=false}Clock.prototype.stack=new Array();Clock.prototype.reset=function(a){this.current=this.lo;this.flag=false;this.k=null;if(a){this.simulator=a}this.simulator.reset(this)};Clock.prototype.stop=function(){this.flag=true};Clock.prototype.step=function(a){var b=function(){this.current+=this.dt;this.simulator.postProcess(this.current);if(a){a()}}.bind(this);switch(this.method){case"Euler":this.simulator.strobe(this.current,this.epochs[0],b);break;case"RK4":var c=[this.current,this.current+this.dt/2,this.current+this.dt/2,this.current+this.dt];kloop(this.epochs,function(d,f,e){this.simulator.strobe(c[e],d,f)}.bind(this),b);break}};Clock.prototype.terminate=function(){this.simulator.terminate()};Clock.prototype.epochs=["k0","k1","k2","k3"];Clock.prototype.runAll=function(){this.isRunAll=true;var b=(arguments.length==0)?this.hi:arguments[0];for(var a=this.current;a<=b-this.dt;a+=this.dt){this.step()}this.isRunAll=false};Clock.prototype.run=function(){if(this.running){return}var b=(arguments.length<=1)?this.hi:arguments[1];var a=this;this.quitter=function(){return this.flag||this.current>b-this.dt}.bind(this);this.timer=null;this.k=arguments[0];this.everyk=arguments[2];this.ping=function(){if(this.quitter()){this.running=false;Clock.curClock=null;clearInterval(this.timer);if(this.k){this.k.call(this.simulator.scope)}this.domultirun=false;this.newspeed=false;return true}this.step(this.iterate);if(this.everyk){this.everyk.call(this.simulator.scope)}if(this.newspeed&&!this.domultirun){this.newspeed=false;this.runit()}return false}.bind(this);this.running=true;Clock.curClock=this;this.runit()};Clock.prototype.multirun=function(){for(var a=0;a<this.postInterval;a++){if(this.ping()){this.domultirun=false;return}}};Clock.prototype.restart=function(){Clock.curClock=this;this.runit()};Clock.prototype.cont=function(){if(this.running||this.timer==null){return}this.flag=false;this.running=true;this.runit()};Clock.prototype.runit=function(){clearInterval(this.timer);if(this.postInterval>0){this.domultirun=true;this.timer=setInterval(this.multirun.bind(this),0)}else{this.timer=setInterval(this.ping,this.speed)}};Clock.prototype.halt=function(){clearInterval(this.timer);this.running=false};Clock.prototype.isFirst=function(){return this.current==this.lo};Clock.prototype.isLast=function(){return Math.abs(this.current-this.hi)<0.001||(this.current-0.001)>this.hi-this.dt};Clock.prototype.resetIterate=function(){delete this.iterate};Clock.prototype.setSpeed=function(a){this.speed=a};Clock.prototype.process=function(){var a=(arguments.length==0)?this.hi:arguments[0];while(this.current<=a-this.dt&&!this.flag){this.step()}};Clock.prototype.toString=function(){return sprintf("[Clock %f %f %f %s]",this.lo,this.hi,this.dt,this.method)};Clock.prototype.getArg=function(a){if(typeof a=="number"){return a}return +a.value};function pscopemaker(d,c){var b=function(e){this.TIME=e};b.prototype=Object.create(c);b.prototype.constructor=b;b.prototype.self=c;b.prototype.toString=function(){return sprintf("[PluginScope %s %f]",this.self.name,this.TIME)};b.prototype.setTime=function(e){this.TIME=e};for(var a=0;a<d.length;a++){(function(){var e=d[a];b.prototype.__defineGetter__(e.name,function(){return e.value(this.TIME,this)})})()}return b}function scopemaker(d,c){var b=function(e){this.TIME=e};b.prototype=Object.create(c);b.prototype.constructor=b;b.prototype.self=c;b.prototype.toString=function(){return sprintf("[Scope %s %f]",this.self.name,this.TIME)};b.prototype.setTime=function(e){this.TIME=e};b.prototype.__defineGetter__("Super",function(){return(this.self.Super)?this.self.Super.scope:null});for(var a in d){if(d[a].isCommand()){continue}if(d[a].isCapsule()||d[a].isPlugin()){(function(){var e=d[a];b.prototype.__defineGetter__(e.name,function(){return e.scope})})();continue}if(d[a].isSimulator()){(function(){var e=d[a];b.prototype.__defineGetter__(e.name,function(){return e})})();continue}if(d[a].isLVariable){(function(){var e=d[a];b.prototype.__defineSetter__(e.name,function(f){return e.value=f})})()}(function(){var e=d[a];b.prototype.__defineGetter__(e.name,function(){return e.value(this.TIME,this)})})()}return b}function integrator(a,f,h,c,m,b){switch(f.kind){case"Sequence":if(a=="Euler"||(a=="RK4"&&b=="k3")){var l=f.doNext.call(m,h);f.update(h,c,l)}break;case"Stock":switch(a){case"Euler":var l=f.getDeriv().call(m,h);f.update(h,c,l*c);break;case"RK4":switch(b){case"k0":var k=f.getDeriv().call(m,h);f.update(h,c/2,c/2*k);f.k1=k;break;case"k1":var g=f.getDeriv().call(m,h+c/2);f.update(h,c/2,c/2*g);f.k2=g;break;case"k2":var e=f.getDeriv().call(m,h+c/2);f.update(h,c,c*e);f.k3=e;break;case"k3":var d=f.getDeriv().call(m,h+c);f.clear(h+c/2);f.update(h,c,(c/6)*(f.k1+2*f.k2+2*f.k3+d));break}}}}function Cachemaker(exp,fixed){if(typeof exp=="string"||typeof exp=="number"){eval(sprintf("function f0(TIME, Super){return %s;}",new String(exp).trim()))}else{if(typeof exp!="function"){eval(sprintf("function f0(TIME, Super){return %s;}",JSON.stringify(exp).trim()))}else{function f0(t,Super){return exp.call(this,t,Super)}}}this.cache=null;this.t0=null;this.reset=function(){this.cache=null;this.t0=null};var that=this;this.f=(fixed)?function(t,scope){if(that.cache==null){that.cache=f0.call(scope,t,scope.Super)}return that.cache}:function(t,scope){if(t!=undefined&&t!=that.t0){that.t0=t;that.cache=f0.call(scope,t,scope.Super)}return that.cache}}var nsutil={math:{pi:Math.PI,pio2:Math.PI/2,mpio2:-Math.PI/2,mpi:-Math.PI,pi2:2*Math.PI,normalize:function(a){var b=a%this.pi2;if(b>this.pi){b-=this.pi2}else{if(b<=this.mpi){b+=this.pi2}}return b},distance:function(d,c){return Math.sqrt((d.x-c.x)*(d.x-c.x)+(d.y-c.y)*(d.y-c.y))}},wrap:function(b,a){if(b>=0&&b<a){return b}return((b%a)+a)%a},interpolate:function(b,f){if(f[b]!=undefined){return f[b]}var d=Object.keys(f);if(b<d[0]){return f[0]}if(b>d[d.length-1]){return f[d[d.length-1]]}var a=nsutil.binaryIndexOf(d,b);var e,c;if(d[a]>b){c=d[a];e=d[a-1]}else{c=d[a+1];e=d[a]}return f[e]+((f[c]-f[e])/(c-e))*(b-e)},binaryIndexOf:function(a,e){var d=0;var f=a.length-1;var b;var c;while(d<=f){b=Math.floor((d+f)/2);c=+a[b];if(c<e){d=b+1}else{if(c>e){f=b-1}else{return b}}}return b},coordsOrNum:function(b,a){if(typeof b=="number"&&typeof a=="number"){return[b,a]}if(Array.isArray(b)){return b}if(typeof b=="object"){if("row" in b||"col" in b){return[b.row,b.col]}if("x" in b||"y" in a){return[b.y,b.x]}}},collect:function(){var b={};var a=arguments.length;for(var c=0;c<a;c++){for(p in arguments[c]){if(arguments[c].hasOwnProperty(p)){b[p]=arguments[c][p]}}}return b},request:function(url,callback){var req=new XMLHttpRequest;req.open("GET",url,true);req.setRequestHeader("Accept","application/js");req.onreadystatechange=function(){if(req.readyState===4){if(req.status<300){callback(null,eval(req.responseText))}else{callback(req.status)}}};req.send(null)},download:function(d,c){var b=new Blob([d],{type:"text/csv"});var a=document.createElement("a");a.download=c;a.innerHTML="Download File";if(window.webkitURL!=null){a.href=window.webkitURL.createObjectURL(b)}else{a.href=window.URL.createObjectURL(b);a.onclick=function(e){document.body.removeChild(e.target)};a.style.display="none";document.body.appendChild(a)}a.click()},sortPlugins:function(a){var b=function(c){switch(c.pluginType){case"Tabulator":return 0;default:return 100}};return _.sortBy(a,b)}};function SimGen(schema,controls,name){var CapGen=function(schema,name,properties,pins){var capparts=capbuilder(schema,name,properties,pins);return new Capsule(capparts.name,capparts.comps,null,controls)};var LVarGen=function(schema,name,properties){var ans=new LVariable(name);ans.initial=funcify(properties,schema.initial);return ans};var StockGen=function(schema,name,properties){var ans=new Stock(name);ans.initial=funcify(properties,schema.initial);return ans};var FlowGen=function(schema,name,properties,stocks){var ans=new Flow(name,stocks[schema.input],stocks[schema.output]);ans.exp=funcify(properties,schema.exp);return ans};var TermGen=function(schema,name,properties){var ans=new Term(name);ans.exp=funcify(properties,schema.exp);return ans};var SliderGen=function(schema,name,properties){var ans=new Slider(name);if("exp" in schema){ans.exp=funcify(properties,schema.exp)}return ans};var PropGen=function(schema,name,properties){var ans=new Property(name);ans.exp=funcify(properties,schema.exp);return ans};var InPinGen=function(schema,name,properties){var ans=new InPin(name);ans.exp=funcify(properties,schema.exp);return ans};var OutPinGen=function(schema,name,properties){var ans=new OutPin(name);ans.exp=funcify(properties,schema.exp);return ans};var VarGen=function(schema,name,properties){var ans=new Stock(name);ans.initial=funcify(properties,schema.initial);ans.deriv=funcify(properties,schema.prime);return ans};var SeqGen=function(schema,name,properties){var ans=new Sequence(name);ans.initial=funcify(properties,schema.initial);ans.next=funcify(properties,schema.next);return ans};var ChipGen=function(schema,name,properties){var base=schemaGet(schema.base);var pinz=("pins" in schema)?schema.pins:schema.inputs;var ans=CapGen(base,name,properties,pinz);return ans};var ClockedChipGen=function(schema,name,properties){var base=schemaGet(schema.base);var pinz=("pins" in schema)?schema.pins:schema.inputs;var capparts=capbuilder(base,name,properties,pinz);return new ClockedChip(capparts.name,capparts.comps,schema.clock)};var CommandGen=function(schema,name,properties){var ans=new Command(name,schema.when);ans.exp=funcify(properties,schema.exp);return ans};var AgentGen=function(schema,name,properties,id){var properties1=merge(properties,{id:id});var capparts=capbuilder(schema,name,properties1);return new Agent(capparts.name,capparts.comps,id)};var AgentVectorGen=function(schema,name,properties){var agentbuilder=function(id){var base=schemaGet(schema.base);return AgentGen(base,base.name+"_"+id,properties,id)};var av=new AgentVector(name,agentbuilder,schema.count,schema.rows,schema.cols);var pinz=("pins" in schema)?schema.pins:schema.inputs;if(pinz){for(var pin in pinz){av[pin]=funcify(properties,pinz[pin])}}return av};var CellGen=function(schema,name,properties,r,c){var properties1=merge(properties,{id:r+"_"+c});var capparts=capbuilder(schema,name,properties1);return new Cell(capparts.name,capparts.comps,r,c)};var CellMatrixGen=function(schema,name,properties){var cellbuilder=function(r,c){var base=schemaGet(schema.base);return CellGen(base,base.name+"_"+r+"_"+c,properties,r,c)};var cm=new CellMatrix(name,cellbuilder,schema.rows,schema.cols);var pinz=("pins" in schema)?schema.pins:schema.inputs;if(pinz){for(var pin in pinz){cm[pin]=funcify(properties,pinz[pin])}}return cm};var NodeGen=function(schema,name,properties,id){var properties1=merge(properties,{id:id});var capparts=capbuilder(schema,name,properties1);return new Node(capparts.name,capparts.comps,id)};var NodeNetworkGen=function(schema,name,properties){var nodebuilder=function(id){var base=schemaGet(schema.base);return NodeGen(base,base.name+"_"+id,properties,id)};var nn=new NodeNetwork(name,nodebuilder,schema.count,schema.nconnect);var pinz=("pins" in schema)?schema.pins:schema.inputs;if(pinz){for(var pin in pinz){nn[pin]=funcify(properties,pinz[pin])}}return nn};var SimWorldGen=function(schema,name,properties){var agentbuilder=function(id){var agentbase=schemaGet(schema.agentbase);return AgentGen(agentbase,agentbase.name+"_"+id,properties,id)};var cellbuilder=function(r,c){var cellbase=schemaGet(schema.cellbase);return CellGen(cellbase,cellbase.name+"_"+r+"_"+c,properties,r,c)};var sw=new Simworld(name,agentbuilder,cellbuilder,schema.rows,schema.cols,schema.count);var apinz=("apins" in schema)?schema.apins:schema.ainputs;var cpinz=("cpins" in schema)?schema.cpins:schema.cinputs;if(apinz){for(var pin in apinz){sw.agentvector[pin]=funcify(properties,apinz[pin])}}if(cpinz){for(var pin in cpinz){sw.cellmatrix[pin]=funcify(properties,cpinz[pin])}}return sw};var CodeChipGen=function(schema,name,properties,methods){return new CodeChip(name,methods[schema.method],schema.initial,schema.inputs,schema.method)};var PluginGen=function(schema,name,properties){var base=schemaGet(schema.base);var plugin=Object.create(base.prototype);var sproperties=(typeof schema.properties=="function")?schema.properties():schema.properties;var pinz=("pins" in schema)?schema.pins:schema.inputs;base.call(plugin,name,sproperties,pinz,properties);return plugin};var capbuilder=function(schema,name,properties,pins){var allProperties=merge(schema.properties,properties);var methods=schema.methods;var stocks=new Object();var comps=new Array();for(var prop in schema.components){var pschema=schema.components[prop];if("specifies" in pschema){pschema.type=pschema.specifies}if(pschema.type=="Stock"){stocks[prop]=dispatch[pschema.type](pschema,prop,allProperties,methods);comps.push(stocks[prop])}}for(var prop in schema.components){var pschema=schema.components[prop];if("specifies" in pschema){pschema.type=pschema.specifies}if(pschema.type=="Stock"){continue}if(pschema.type=="InPin"&&(pins&&pins[prop])){pschema={type:"InPin",exp:pins[prop]}}comps.push(dispatch[pschema.type](pschema,prop,allProperties,(pschema.type=="Flow")?stocks:methods))}var name=(name)?name:schema.name;return{name:name,comps:comps}};var merge=function(p0,p1){var ans=new Object();for(var i in p0){ans[i]=p0[i]}for(var i in p1){ans[i]=p1[i]}return ans};var funcify=function(props,exp){exp=exp||"0";var ans;if(!props||Object.keys(props).length==0){if(typeof exp=="function"){return exp}ans="function f0(TIME, Super){var __ans__ = "+exp+"; return __ans__;}";eval(ans);return f0}else{var args=Object.keys(props);var exp1=(typeof exp=="function")?"("+exp.toString()+").call(this, TIME, Super)":exp;var exp0="function (TIME, Super){return "+exp1+"}";var vals=args.map(function(x){return props[x]});eval("function f0("+args.toString()+") {var __ans__ = "+exp0+"; return __ans__;}");var ans=f0.apply(this,vals);return ans}};var dispatch={Capsule:CapGen,Stock:StockGen,Flow:FlowGen,Variable:VarGen,Sequence:SeqGen,Chip:ChipGen,Command:CommandGen,Term:TermGen,Property:PropGen,InPin:InPinGen,OutPin:OutPinGen,AgentVector:AgentVectorGen,CellMatrix:CellMatrixGen,NodeNetwork:NodeNetworkGen,SimWorld:SimWorldGen,CodeChip:CodeChipGen,LVariable:LVarGen,ClockedChip:ClockedChipGen,Plugin:PluginGen,Slider:SliderGen};if("specifies" in schema){schema.type=schema.specifies}var ans=dispatch[schema.type](schema,(name)?name:schema.name,null,null,controls);return ans}var RANDOM=Math.random;Capsule.prototype.RANDOM=RANDOM;var BINOMIAL=function(d,c){var a=0;for(var b=0;b<d;b++){if(Math.random()<c){a++}}return a};Capsule.prototype.BINOMIAL=BINOMIAL;var STEP=function(b,a){if(Clock.curClock.current>a){return b}return 0};Capsule.prototype.STEP=STEP;var NORMAL=function(b,g){var e,d,a,f;do{e=2*Math.random()-1;d=2*Math.random()-1;a=e*e+d*d}while(a>=1||a==0);var h=Math.sqrt(-2*Math.log(a)/a);return g*(e*h)+b};Capsule.prototype.NORMAL=NORMAL;var TOTAL=function(e,b){var c=0;for(var d in b){c+=e.call(this,b[d])}return c};Capsule.prototype.TOTAL=TOTAL;var COUNT=function(c,b){return TOTAL.call(this,function(a){return(c(a))?1:0},b)};Capsule.prototype.COUNT=COUNT;var Schema=function(){var a=new Object();this.defineSchema=function(b,c){a[b]=c};this.getSchema=function(b){return a[b]}};var currentSchema=new Schema();function defineSchema(a,b){currentSchema.defineSchema(a,b)}function schemaGet(a){return(typeof a=="string")?currentSchema.getSchema(a):a}var NovaManager=function(k,h,c,e,d,a,b,f,g){return(function(){var l={runStatus:{running:false,stopped:false,reset:false,terminated:false},timeField:e,delay:f,clocklo:c.lo,clockhi:+d.value,clockdt:(typeof a=="number")?a:("valueAsNumber" in a)?a.valueAsNumber:+a.value,clockmethod:c.method,fixSpeed:function(m){c.speed=m;c.newspeed=true},fixClock:function(n,m){l["clock"+n]=m},step:function(){if(l.runStatus.running||c.current>=c.hi){return}l.runStatus.reset=false;c.flag=false;c.run(null,c.current+c.dt);l.runStatus.stopped=true},iterate:function(m){l.timeField.value=c.current;k()},terminate:function(){l.runStatus.running=false;l.runStatus.stopped=true;if(l.runStatus.terminated){c.stop()}else{l.runStatus.terminated=true;c.terminate()}},stop:function(){l.runStatus.running=false;l.runStatus.stopped=true;c.stop()},restart:function(){if(l.runStatus.terminated){return}if(l.runStatus.running){return}if(l.runStatus.stopped){c.flag=false;c.run(null)}else{l.run()}},reset:function(m){c.halt();l.runStatus.terminated=false;l.runStatus.running=false;l.runStatus.reset=true;c.lo=l.clocklo;c.hi=d.valueAsNumber;c.dt=(typeof a=="number")?a:("valueAsNumber" in a)?a.valueAsNumber:+a.value;c.method=l.clockmethod;if(m=="fast"){c.isRunAll=true;c.resetIterate()}else{c.iterate=l.iterate}l.timeField.value=c.lo;h(m)},run:function(){if(!l.runStatus.reset){l.reset()}l.runStatus={running:true,stopped:false,reset:false,terminated:false};c.run(null)},showSliderValue:function(n,o){var m=document.getElementById(n);m.value=o},needReset:function(){l.runStatus.reset=false},noReset:function(){l.runStatus.reset=true}};l.timeField.value=c.lo;c.iterate=l.iterate;if(g){c.cleanup=g}return{step:l.step,stop:l.stop,terminate:l.terminate,restart:l.restart,reset:l.reset,run:l.run,fixSpeed:l.fixSpeed,showSliderValue:l.showSliderValue,needReset:l.needReset,fixClock:l.fixClock,clock:c}})()};sprintfWrapper={init:function(){if(typeof arguments=="undefined"){return null}if(arguments.length<1){return null}if(typeof arguments[0]!="string"){return null}if(typeof RegExp=="undefined"){return null}var k=arguments[0];var c=new RegExp(/(%([%]|(\-)?(\+|\x20)?(0)?(\d+)?(\.(\d)?)?([bcdfosxX])))/g);var g=new Array();var m=new Array();var a=0;var h=0;var n=0;var d=0;var l="";var f=null;while(f=c.exec(k)){if(f[9]){a+=1}h=d;n=c.lastIndex-f[0].length;m[m.length]=k.substring(h,n);d=c.lastIndex;g[g.length]={match:f[0],left:f[3]?true:false,sign:f[4]||"",pad:f[5]||" ",min:f[6]||0,precision:f[8],code:f[9]||"%",negative:parseInt(arguments[a])<0?true:false,argument:String(arguments[a])}}m[m.length]=k.substring(d);if(g.length==0){return k}if((arguments.length-1)<a){return null}var b=null;var f=null;var e=null;for(e=0;e<g.length;e++){if(g[e].code=="%"){substitution="%"}else{if(g[e].code=="b"){g[e].argument=String(Math.abs(parseInt(g[e].argument)).toString(2));substitution=sprintfWrapper.convert(g[e],true)}else{if(g[e].code=="c"){g[e].argument=String(String.fromCharCode(parseInt(Math.abs(parseInt(g[e].argument)))));substitution=sprintfWrapper.convert(g[e],true)}else{if(g[e].code=="d"){g[e].argument=String(Math.abs(parseInt(g[e].argument)));substitution=sprintfWrapper.convert(g[e])}else{if(g[e].code=="f"){g[e].argument=String(Math.abs(parseFloat(g[e].argument)).toFixed(g[e].precision?g[e].precision:6));substitution=sprintfWrapper.convert(g[e])}else{if(g[e].code=="o"){g[e].argument=String(Math.abs(parseInt(g[e].argument)).toString(8));substitution=sprintfWrapper.convert(g[e])}else{if(g[e].code=="s"){g[e].argument=g[e].argument.substring(0,g[e].precision?g[e].precision:g[e].argument.length);substitution=sprintfWrapper.convert(g[e],true)}else{if(g[e].code=="x"){g[e].argument=String(Math.abs(parseInt(g[e].argument)).toString(16));substitution=sprintfWrapper.convert(g[e])}else{if(g[e].code=="X"){g[e].argument=String(Math.abs(parseInt(g[e].argument)).toString(16));substitution=sprintfWrapper.convert(g[e]).toUpperCase()}else{substitution=g[e].match}}}}}}}}}l+=m[e];l+=substitution}l+=m[e];return l},convert:function(b,d){if(d){b.sign=""}else{b.sign=b.negative?"-":b.sign}var a=b.min-b.argument.length+1-b.sign.length;var c=new Array(a<0?0:a).join(b.pad);if(!b.left){if(b.pad=="0"||d){return b.sign+c+b.argument}else{return c+b.sign+b.argument}}else{if(b.pad=="0"||d){return b.sign+b.argument+c.replace(/0/g," ")}else{return b.sign+b.argument+c}}}};sprintf=sprintfWrapper.init;