//JNovaScriptX.js 0.0.2
//Completely Javascript Implementation of NovaScript
//http://novamodeler.com
//(c) 2014-2015 Richard Salter
// Prototypes
// --------------
//--- Component Prototype
//Plugin prototype
//-- Component definitions
//-- Iteratable - common ancestor of Stock and Sequence
//-- Local Variable
//Components
//--------------
//-- Stock
//-- Sequence
//-- Converter - common ancestor for Term, InPin and OutPin
//!!
//-- Flow
//Flow.prototype.reset = function(clock) {}
//-- Term
//-- Slider
//-- Property
//-- InPin
//-- OutPin
//-- CodeChip
//-- Command
// Higher Order Components and Aggregators
// --------------
//-- Capsule
//-- Clocked Chip
//-- AgentVector
//- Agent - extended capsule constructor for agentvectors with av primops added
//to prototype
//-- CellMatrix
//	kloop2(this.matrix, function(x, k1){x.iterate(t, epoch, k1)}, k);
//- Cell - extended capsule constructor for cellmatrices with cm primops added
//to prototype
//-- NodeNetwork
//- Node - extended capsule constructor for nodenetworks with nn primops added
//to prototype
//-- SimWorld
//Simworld.prototype.AGENTS = this.agentvector.AGENTS;
//Simworld.prototype.CELLS = this.cellmatrix.CELLS;
//Core
//--------------
//-- Clock
//Plugin ScopeMaker
//ScopeMaker
//Integrator
//Cache Maker
//Utility Functions
//--------------
//Simulation Generator
//--------------
//			var exp1 = (typeof exp == "function") ? "(" + exp.toString()
//					+ ").call(this, TIME, Super)" : exp;
//Universal Primops
//--------------
//Managers
//--------------
//schema management
// NovaManager
//Library
//--------------
//Color blender
//exports.Clock = Clock;
//exports.SimGen = SimGen;
function comp_proto(t,e){this.name=t,this.kind=e,this.exp="0.0",this._exp="0.0"}function pl_proto(t,e,i,n,r){comp_proto.call(this,t,"Plugin"),delete this.exp,this.pluginType=e,this.pins=new Array,this.comps=new Array,this.preOrPost="post"
for(var o=0;o<i.length;o++)this[i[o]]=new InPin(i[o]),this.pins.push(this[i[o]]),this.comps.push(this[i[o]])
for(var o=0;o<n.length;o++)this[n[o]]=new OutPin(n[o]),this.pins.push(this[n[o]]),this.comps.push(this[n[o]])
for(var o=0;o<r.length;o++)this[r[o]]=new Term(r[o]),this.comps.push(this[r[o]])
this.scopemaker=pscopemaker(this.comps,this),this.scope=new this.scopemaker(0)}function Iterable(t,e){comp_proto.call(this,t,e),this.last="0.0",this.values=new Object,this.init=null}function LVariable(t){comp_proto.call(this,t,"LVariable"),this._value=0}function Stock(t){Iterable.call(this,t,"Stock"),this.deriv="0.0",this.inFlow=null,this.outFlow=null,this.k0=this.k1=this.k2=this.k3=null}function Sequence(t){Iterable.call(this,t,"Sequence"),delete this._deriv,delete this.deriv,this.next=0}function Converter(t,e){comp_proto.call(this,t,e),this.cache=new Cachemaker(this.exp)}function Flow(t,e,i){Converter.call(this,t,"Flow"),this.inp=e,this.outp=i,e&&(e.outFlow=this),i&&(i.inFlow=this),this._exp="0.0"}function Term(t){Converter.call(this,t,"Term")}function Slider(t){Converter.call(this,t,"Term"),this.exp=function(){return+this.controls[t].value}}function Property(t){Converter.call(this,t,"Term")}function InPin(t){Converter.call(this,t,"InPin")}function OutPin(t){Converter.call(this,t,"OutPin")}function CodeChip(t,e,i,n,r){comp_proto.call(this,t,"CodeChip"),this.method="code"in e?e.code:e,this.methodname=r,this.initial=i,this.inputs=n,this.cacheable="cacheable"in e?e.cacheable:!0,this.preOrPost="when"in e?e.preOrPost:"post"
var o
if(this.initial){var s="function"==typeof this.initial?this.initial():this.initial
o=this.method.apply(this.cap.scope,s)}else o=this.method
this.value=this.memoize(o,this.inputs,this.cacheable)}function Command(name,preOrPost){function block(t){exp.call(this,t)}comp_proto.call(this,name,"Command")
var exp=this.exp
"string"==typeof exp&&eval(sprintf("function block(t){%s}",new String(exp).trim())),this.value=block,this.preOrPost=preOrPost?preOrPost:"post",this.initCom=0==name.indexOf("initial"),this.finCom=0==name.indexOf("final")}function Capsule(t,e,i,n){comp_proto.call(this,t,i?i:"Capsule"),this.controls=n,this.components=new Object
for(var r=0;r<e.length;r++)this.components[e[r].name]=e[r]
this.clock=null,this.scope=null,this.Super=null,this.iterables=new Array,this.resetables=new Array,this.precoms=new Array,this.postcoms=new Array,this.preplugins=new Array,this.inpins=new Object,this.outpins=new Object,this.simulators=new Array,this.plugins=new Array
for(var o in this.components){var s=this.components[o]
this[s.name]=s,s.setCap(this),s.isSimulator()?(s.Super=this,this.simulators.push(s)):s.isIterable()?this.iterables.push(s):s.isCommand()?("pre"==s.preOrPost&&this.precoms.push(s),"post"==s.preOrPost&&this.postcoms.push(s)):s.isConverter()||s.isCodeChip()||s.isLVariable()||s.isSimulator()&&!s.isClockedChip()?this.resetables.push(s):s.isPlugin()&&("pre"==s.preOrPost?this.preplugins.push(s):this.plugins.push(s)),s.isInPin()?this.inpins[s.name]=s:s.isOutPin()&&(this.outpins[s.name]=s)}this.preplugins=nsutil.sortPlugins(this.preplugins),this.plugins=nsutil.sortPlugins(this.plugins),this.scopemaker=scopemaker(this.components,this)}function ClockedChip(t,e,i){Capsule.call(this,t,e,"ClockedChip"),Array.isArray(i)?(this.clock=Object.create(Clock.prototype),Clock.apply(this.clock,i)):this.clock=new Clock(i.lo,i.hi,i.dt,i.method)}function AgentVector(t,e,i,n,r,o){comp_proto.call(this,t,"AgentVector"),this.recycle=[],this.capgen=e,this.counter=i,this.count=null==i?0:"function"==typeof this.counter?this.counter():this.counter,this.rows=n,this.cols=r,this.lastId=0,this.inpins={Init_Count:new InPin("Init_Count")},this.inpinExps=new Object,this.simworld=o,this.generate(),this.pinsDone=!1,this.inPinSetup(),this.outPinSetup(),this.births={},this.deaths={},this.vscopes=[],this.__defineGetter__("AData",function(){return this.vscopes})}function kloop(t,e,i){var n=Object.keys(t),r=function(){if(0==n.length)i()
else{var o=n.shift()
e(t[o],r,o)}}
r()}function Agent(t,e,i){Capsule.call(this,t,e,"Agent"),this.kind="Agent",this.id=i,this.x=0,this.y=0,this.theta=0,this.zombie=!1,this.parent=null,this.birth=0,this.fresh=!0,this.outDataNames=["x","y"].concat(Object.keys(this.outpins))}function CellMatrix(t,e,i,n,r){comp_proto.call(this,t,"CellMatrix"),this.capgen=e,this.rows=i,this.cols=n,this.matrix=new Array,this.cellsById=new Object,this.inpinExps=new Object,this.simworld=r
for(var o=0;o<this.rows;o++){this.matrix[o]=new Array
for(var s=0;s<this.cols;s++){var p=e(o,s,Cell)
p.cellmatrix=this,p.Super=this,p.Coords={row:o,col:s},this.matrix[o].push(p),this.cellsById[p.id]=p,this.simworld&&(p.myagents=new Object)}}this.inPinSetup(),this.outPinSetup(),r&&(this.simworld=r)}function kloop2(t,e,i){var n=Object.keys(t)
if(0==n.length)i()
else{var r=[],o=null,s=function(){if(0==r.length)if(0==n.length)i()
else{o=n.shift(),r=Object.keys(t[o])
var p=r.shift()
e(t[o][p],s)}else{var p=r.shift()
e(t[o][p],s,o,p)}}
s()}}function Cell(t,e,i,n){Capsule.call(this,t,e,"Cell"),this.row=i,this.col=n,this.id=sprintf("C%d:%d",i,n)}function NodeNetwork(t,e,i,n,r){comp_proto.call(this,t,"NodeNetwork"),this.capgen=e,this.nconnect=n,this.nodes=new Array,this.inpinExps=new Object,this.networld=r,this.count=i,this.connexions=new Array
for(var o=0;o<this.count;o++){var s=e(o,Node)
s.nodenetwork=this,s.Super=this,s.id=o,this.nodes[o]=s,this.networld&&(s.myagents=new Object)}this.inPinSetup(),this.outPinSetup(),this.fstTime=!0,r&&(this.networld=r)}function Node(t,e,i){Capsule.call(this,t,e,"Node"),this.id=i,this.connexions_in=new Array,this.connexions_out=new Array,this.outStrength=0,this.inStrength=0}function Simworld(t,e,i,n,r,o){comp_proto.call(this,t,"Simworld"),this.agentgen=e,this.cellgen=i,this.rows=n,this.cols=r,this.count=o,this.agentvector=new AgentVector(t+"_agent",e,o,n,r,this),this.cellmatrix=new CellMatrix(t+"_cell",i,n,r,this),this.agentvector.Super=this,this.cellmatrix.Super=this}function Clock(t,e,i,n){this.lo=t,this.hi=this.getArg(e),this.dt=i?i:1,this.current=t,this.flag=!1,this.newspeed=!1,this.domultirun=!1,this.speed=0,this.method=n?n:"Euler",this.cleanup=function(){},this.isRunAll=!1}function pscopemaker(t,e){var i=function(t){this.TIME=t}
i.prototype=Object.create(e),i.prototype.constructor=i,i.prototype.self=e,i.prototype.toString=function(){return sprintf("[PluginScope %s %f]",this.self.name,this.TIME)},i.prototype.setTime=function(t){this.TIME=t}
for(var n=0;n<t.length;n++)!function(){var e=t[n]
i.prototype.__defineGetter__(e.name,function(){return e.value(this.TIME,this)})}()
return i}function scopemaker(t,e){var i=function(t){this.TIME=t}
i.prototype=Object.create(e),i.prototype.constructor=i,i.prototype.self=e,i.prototype.toString=function(){return sprintf("[Scope %s %f]",this.self.name,this.TIME)},i.prototype.setTime=function(t){this.TIME=t},i.prototype.__defineGetter__("Super",function(){return this.self.Super?this.self.Super.scope:null})
for(var n in t)t[n].isCommand()||(t[n].isCapsule()||t[n].isPlugin()?!function(){var e=t[n]
i.prototype.__defineGetter__(e.name,function(){return e.scope})}():t[n].isSimulator()?!function(){var e=t[n]
i.prototype.__defineGetter__(e.name,function(){return e})}():(t[n].isLVariable&&function(){var e=t[n]
i.prototype.__defineSetter__(e.name,function(t){return e.value=t})}(),function(){var e=t[n]
i.prototype.__defineGetter__(e.name,function(){return e.value(this.TIME,this)})}()))
return i}function integrator(t,e,i,n,r,o){switch(e.kind){case"Sequence":if("Euler"==t||"RK4"==t&&"k3"==o){var s=e.doNext.call(r,i)
e.update(i,n,s)}break
case"Stock":switch(t){case"Euler":var s=e.getDeriv().call(r,i)
e.update(i,n,s*n)
break
case"RK4":switch(o){case"k0":var p=e.getDeriv().call(r,i)
e.update(i,n/2,n/2*p),e.k1=p
break
case"k1":var c=e.getDeriv().call(r,i+n/2)
e.update(i,n/2,n/2*c),e.k2=c
break
case"k2":var a=e.getDeriv().call(r,i+n/2)
e.update(i,n,n*a),e.k3=a
break
case"k3":var u=e.getDeriv().call(r,i+n)
e.clear(i+n/2),e.update(i,n,n/6*(e.k1+2*e.k2+2*e.k3+u))}}}}function Cachemaker(exp,fixed){function f0(t,e){return exp.call(this,t,e)}"string"==typeof exp||"number"==typeof exp?eval(sprintf("function f0(TIME, Super){return %s;}",new String(exp).trim())):"function"!=typeof exp&&eval(sprintf("function f0(TIME, Super){return %s;}",JSON.stringify(exp).trim())),this.cache=null,this.t0=null,this.reset=function(){this.cache=null,this.t0=null}
var that=this
this.f=fixed?function(t,e){return null==that.cache&&(that.cache=f0.call(e,t,e.Super)),that.cache}:function(t,e){return void 0!=t&&t!=that.t0&&(that.t0=t,that.cache=f0.call(e,t,e.Super)),that.cache}}function SimGen(schema,controls,name){var CapGen=function(t,e,i,n){var r=capbuilder(t,e,i,n)
return new Capsule(r.name,r.comps,null,controls)},LVarGen=function(t,e,i){var n=new LVariable(e)
return n.initial=funcify(i,t.initial),n},StockGen=function(t,e,i){var n=new Stock(e)
return n.initial=funcify(i,t.initial),n},FlowGen=function(t,e,i,n){var r=new Flow(e,n[t.input],n[t.output])
return r.exp=funcify(i,t.exp),r},TermGen=function(t,e,i){var n=new Term(e)
return n.exp=funcify(i,t.exp),n},SliderGen=function(t,e,i){var n=new Slider(e)
return"exp"in t&&(n.exp=funcify(i,t.exp)),n},PropGen=function(t,e,i){var n=new Property(e)
return n.exp=funcify(i,t.exp),n},InPinGen=function(t,e,i){var n=new InPin(e)
return n.exp=funcify(i,t.exp),n},OutPinGen=function(t,e,i){var n=new OutPin(e)
return n.exp=funcify(i,t.exp),n},VarGen=function(t,e,i){var n=new Stock(e)
return n.initial=funcify(i,t.initial),n.deriv=funcify(i,t.prime),n},SeqGen=function(t,e,i){var n=new Sequence(e)
return n.initial=funcify(i,t.initial),n.next=funcify(i,t.next),n},ChipGen=function(t,e,i){var n=schemaGet(t.base),r="pins"in t?t.pins:t.inputs,o=CapGen(n,e,i,r)
return o},ClockedChipGen=function(t,e,i){var n=schemaGet(t.base),r="pins"in t?t.pins:t.inputs,o=capbuilder(n,e,i,r)
return new ClockedChip(o.name,o.comps,t.clock)},CommandGen=function(t,e,i){var n=new Command(e,t.when)
return n.exp=funcify(i,t.exp),n},AgentGen=function(t,e,i,n){var r=merge(i,{id:n}),o=capbuilder(t,e,r)
return new Agent(o.name,o.comps,n)},AgentVectorGen=function(t,e,i){var n=function(e){var n=schemaGet(t.base)
return AgentGen(n,n.name+"_"+e,i,e)},r=new AgentVector(e,n,t.count,t.rows,t.cols),o="pins"in t?t.pins:t.inputs
if(o)for(var s in o)r[s]=funcify(i,o[s])
return r},CellGen=function(t,e,i,n,r){var o=merge(i,{id:n+"_"+r}),s=capbuilder(t,e,o)
return new Cell(s.name,s.comps,n,r)},CellMatrixGen=function(t,e,i){var n=function(e,n){var r=schemaGet(t.base)
return CellGen(r,r.name+"_"+e+"_"+n,i,e,n)},r=new CellMatrix(e,n,t.rows,t.cols),o="pins"in t?t.pins:t.inputs
if(o)for(var s in o)r[s]=funcify(i,o[s])
return r},NodeGen=function(t,e,i,n){var r=merge(i,{id:n}),o=capbuilder(t,e,r)
return new Node(o.name,o.comps,n)},NodeNetworkGen=function(t,e,i){var n=function(e){var n=schemaGet(t.base)
return NodeGen(n,n.name+"_"+e,i,e)},r=new NodeNetwork(e,n,t.count,t.nconnect),o="pins"in t?t.pins:t.inputs
if(o)for(var s in o)r[s]=funcify(i,o[s])
return r},SimWorldGen=function(t,e,i){var n=function(e){var n=schemaGet(t.agentbase)
return AgentGen(n,n.name+"_"+e,i,e)},r=function(e,n){var r=schemaGet(t.cellbase)
return CellGen(r,r.name+"_"+e+"_"+n,i,e,n)},o=new Simworld(e,n,r,t.rows,t.cols,t.count),s="apins"in t?t.apins:t.ainputs,p="cpins"in t?t.cpins:t.cinputs
if(s)for(var c in s)o.agentvector[c]=funcify(i,s[c])
if(p)for(var c in p)o.cellmatrix[c]=funcify(i,p[c])
return o},CodeChipGen=function(t,e,i,n){return new CodeChip(e,n[t.method],t.initial,t.inputs,t.method)},PluginGen=function(t,e,i){var n=schemaGet(t.base),r=Object.create(n.prototype),o="function"==typeof t.properties?t.properties():t.properties,s="pins"in t?t.pins:t.inputs
return n.call(r,e,o,s,i),r},capbuilder=function(t,e,i,n){var r=merge(t.properties,i),o=t.methods,s=new Object,p=new Array
for(var c in t.components){var a=t.components[c]
"specifies"in a&&(a.type=a.specifies),"Stock"==a.type&&(s[c]=dispatch[a.type](a,c,r,o),p.push(s[c]))}for(var c in t.components){var a=t.components[c]
"specifies"in a&&(a.type=a.specifies),"Stock"!=a.type&&("InPin"==a.type&&n&&n[c]&&(a={type:"InPin",exp:n[c]}),p.push(dispatch[a.type](a,c,r,"Flow"==a.type?s:o)))}var e=e?e:t.name
return{name:e,comps:p}},merge=function(t,e){var i=new Object
for(var n in t)i[n]=t[n]
for(var n in e)i[n]=e[n]
return i},funcify=function(props,exp){exp=exp||"0"
var ans
if(props&&0!=Object.keys(props).length){var args=Object.keys(props),exp1="function"==typeof exp?"("+exp.toString()+").call(this, TIME, Super)":exp,exp0="function (TIME, Super){return "+exp1+"}",vals=args.map(function(t){return props[t]})
eval("function f0("+args.toString()+") {var __ans__ = "+exp0+"; return __ans__;}")
var ans=f0.apply(this,vals)
return ans}return"function"==typeof exp?exp:(ans="function f0(TIME, Super){var __ans__ = "+exp+"; return __ans__;}",eval(ans),f0)},dispatch={Capsule:CapGen,Stock:StockGen,Flow:FlowGen,Variable:VarGen,Sequence:SeqGen,Chip:ChipGen,Command:CommandGen,Term:TermGen,Property:PropGen,InPin:InPinGen,OutPin:OutPinGen,AgentVector:AgentVectorGen,CellMatrix:CellMatrixGen,NodeNetwork:NodeNetworkGen,SimWorld:SimWorldGen,CodeChip:CodeChipGen,LVariable:LVarGen,ClockedChip:ClockedChipGen,Plugin:PluginGen,Slider:SliderGen}
"specifies"in schema&&(schema.type=schema.specifies)
var ans=dispatch[schema.type](schema,name?name:schema.name,null,null,controls)
return ans}function defineSchema(t,e){currentSchema.defineSchema(t,e)}function schemaGet(t){return"string"==typeof t?currentSchema.getSchema(t):t}comp_proto.prototype.value=function(){return eval(this.exp)},comp_proto.prototype.getName=function(t){return t?t.name:""},comp_proto.prototype.setCap=function(t){this.cap=t,this.controls=t.controls},comp_proto.prototype.isKind=function(t){return this.kind==t},comp_proto.prototype.isIterable=function(){return this.isStock()||this.isSequence()},comp_proto.prototype.isCapsule=function(){return this.isKind("Capsule")||this.isClockedChip()||this.isAgent()||this.isCell()},comp_proto.prototype.isSimulator=function(){return this.isCapsule()||this.isKind("AgentVector")||this.isKind("CellMatrix")||this.isKind("Simworld")||this.isKind("NodeNetwork")||this.isKind("NetWorld")},comp_proto.prototype.isCommand=function(){return this.isKind("Command")},comp_proto.prototype.isFlow=function(){return this.isKind("Flow")},comp_proto.prototype.isTerm=function(){return this.isKind("Term")},comp_proto.prototype.isSequence=function(){return this.isKind("Sequence")},comp_proto.prototype.isStock=function(){return this.isKind("Stock")},comp_proto.prototype.isLVariable=function(){return this.isKind("LVariable")},comp_proto.prototype.isInPin=function(){return this.isKind("InPin")},comp_proto.prototype.isOutPin=function(){return this.isKind("OutPin")},comp_proto.prototype.isAgent=function(){return this.isKind("Agent")},comp_proto.prototype.isCell=function(){return this.isKind("Cell")},comp_proto.prototype.isNode=function(){return this.isKind("Node")},comp_proto.prototype.isCodeChip=function(){return this.isKind("CodeChip")},comp_proto.prototype.isClockedChip=function(){return this.isKind("ClockedChip")},comp_proto.prototype.isPlugin=function(){return this.isKind("Plugin")},comp_proto.prototype.isNodeContainer=function(){return this.isKind("NodeNetwork")||this.isKind("NetWorld")},comp_proto.prototype.isConverter=function(){return this.isTerm()||this.isInPin()||this.isOutPin()},pl_proto.prototype=Object.create(comp_proto.prototype),pl_proto.prototype.constructor=pl_proto,pl_proto.prototype.setCap=function(t){comp_proto.prototype.setCap.call(this,t)
for(var e=0;e<this.comps.length;e++)this.comps[e].setCap(t)},pl_proto.prototype.reset=function(t){this.scope=new this.scopemaker(t.current),this.clock=t},pl_proto.prototype.prereset=function(t){},pl_proto.prototype.strobe=function(t,e){this.scope.setTime(t)},pl_proto.prototype.update=function(t,e){},Iterable.prototype=Object.create(comp_proto.prototype),Iterable.prototype.constructor=Iterable,Iterable.prototype.value=function(t){return nsutil.interpolate(t,this.values)},Iterable.prototype.reset=function(t){this.values=new Object,this.store(t.lo,this.init.call(this.cap.scope))},Iterable.prototype.store=function(t,e){this.last=this.values[t]=e},Iterable.prototype.__defineGetter__("initial",function(){return this._exp}),Iterable.prototype.__defineSetter__("initial",function(e){this._exp=e,"string"==typeof e||"number"==typeof e?(eval(sprintf("function init(){return %s;}",e)),this.init=init):"function"==typeof e&&(this.init=e)}),Iterable.prototype.show=function(){return this.values.toSource()},Iterable.prototype.clear=function(t){delete this.values[t]},Iterable.prototype.current=function(){return this.last},LVariable.prototype=Object.create(comp_proto.prototype),LVariable.prototype.constructor=LVariable,LVariable.prototype.__defineGetter__("value",function(){return function(){return this._value}}),LVariable.prototype.__defineSetter__("value",function(t){this._value=t}),LVariable.prototype.__defineGetter__("initial",function(){return this._exp}),LVariable.prototype.__defineSetter__("initial",function(e){this._exp=e,"string"==typeof e||"number"==typeof e?(eval(sprintf("function init(){return %s;}",e)),this.init=init):"function"==typeof e&&(this.init=e)}),LVariable.prototype.reset=function(t){this.value=this.init.call(this.cap.scope)},Stock.prototype=Object.create(Iterable.prototype),Stock.prototype.constructor=Stock,Stock.prototype.setInFlow=function(t){this.inFlow=t,t.outp=this,this.fixDeriv()},Stock.prototype.setOutFlow=function(t){this.outFlow=t,t.inp=this,this.fixDeriv()},Stock.prototype.update=function(t,e,i){this.store(t+e,this.values[t]+i)},Stock.prototype.getDeriv=function(){return this.doDeriv},Stock.prototype.current=function(){return this.last},Stock.prototype.fixDeriv=function(){(null!=this.inFlow||null!=this.outFlow)&&(exp0=this.inFlow?this.inFlow.exp:null,exp1=this.outFlow?this.outFlow.exp:null,this.deriv=this.funcify(exp0,exp1))},Stock.prototype.__defineSetter__("deriv",function(exp){function deriv(t){return exp.call(this,t)}this._deriv=exp,("string"==typeof exp||"number"==typeof exp)&&eval(sprintf("function deriv(TIME){return %s;}",exp)),this.doDeriv=deriv}),Stock.prototype.__defineGetter__("deriv",function(){return this._deriv}),Stock.prototype.toString=function(){return sprintf("[Stock %s %s %s]",this.name,this.getName(this.inFlow),this.getName(this.outFlow))},Stock.prototype.funcify=function(pos,neg){if(null!=pos){if(null==neg)return pos
if("function"==typeof pos){if("function"==typeof neg){var ans=function(t){return pos.call(this,t,this.Super)-neg.call(this,t,this.Super)}
return ans.pos=pos,ans.neg=neg,ans}if("string"==typeof neg)return eval(sprintf("function neg1(TIME, Super){return %s;}",neg)),function(t){return pos.call(this,t)-neg1.call(this,t)}}if("string"==typeof pos){if("function"==typeof neg)return eval(sprintf("function pos1(TIME, Super){return %s;}",pos)),function(t){return pos1.call(this,t,this.Super)-neg.call(this,t,this.Super)}
if("string"==typeof neg)return eval(sprintf("function pos1(TIME, Super){return %s;}",pos)),eval(sprintf("function neg1(TIME, Super){return %s;}",neg)),function(t){return pos1.call(this,t,this.Super)-neg1.call(this,t,this.Super)}}}return"function"==typeof neg?function(t){return-neg.call(this,t)}:"string"==typeof neg?(eval(sprintf("function neg1(TIME){return -(%s);}",neg)),neg1):void 0},Sequence.prototype=Object.create(Iterable.prototype),Sequence.prototype.toString=function(){return sprintf("[Sequence %s]",this.name)},Sequence.prototype.__defineSetter__("next",function(exp){function doNext(t){return exp.call(this)}this._next=exp,("string"==typeof exp||"number"==typeof exp)&&eval(sprintf("function doNext(t){return %s;}",new String(exp).trim())),this.doNext=doNext}),Sequence.prototype.__defineGetter__("next",function(){return this._next}),Sequence.prototype.update=function(t,e,i){this.store(t+e,i)},Converter.prototype=Object.create(comp_proto.prototype),Converter.prototype.__defineGetter__("exp",function(){return this._exp}),Converter.prototype.__defineSetter__("exp",function(t){this._exp=t,this.cache=new Cachemaker(t),this.value=function(t){return this.cache.f(t,this.cap.scope)}}),Converter.prototype.reset=function(t){this.cache.reset()},Converter.prototype.constructor=Converter,Flow.prototype=Object.create(Converter.prototype),Flow.prototype.constructor=Flow,Flow.prototype.__defineGetter__("exp",function(){return this._exp}),Flow.prototype.__defineSetter__("exp",function(t){this._exp=t,this.cache=new Cachemaker(t),this.value=function(t){return this.cache.f(t,this.cap.scope)},this.inp&&this.inp.fixDeriv(),this.outp&&this.outp.fixDeriv()}),Flow.prototype.toString=function(){return sprintf("[Flow %s %s %s]",this.name,this.getName(this.inp),this.getName(this.outp))},Term.prototype=Object.create(Converter.prototype),Term.prototype.toString=function(){return sprintf("[Term %s]",this.name)},Term.prototype.constructor=Term,Slider.prototype=Object.create(Converter.prototype),Slider.prototype.toString=function(){return sprintf("[Slider %s]",this.name)},Slider.prototype.constructor=Slider,Property.prototype=Object.create(Converter.prototype),Property.prototype.toString=function(){return sprintf("[Property %s]",this.name)},Property.prototype.constructor=Term,Property.prototype.__defineGetter__("exp",function(){return this._exp}),Property.prototype.__defineSetter__("exp",function(t){this._exp=t,this.cache=new Cachemaker(t,"fixed"),this.value=function(t){return this.cache.f(t,this.cap.scope)}}),InPin.prototype=Object.create(Converter.prototype),InPin.prototype.toString=function(){return sprintf("[InPin %s]",this.name)},InPin.prototype.constructor=InPin,OutPin.prototype=Object.create(Converter.prototype),OutPin.prototype.toString=function(){return sprintf("[OutPin %s]",this.name)},OutPin.prototype.constructor=OutPin,CodeChip.prototype=Object.create(comp_proto.prototype),CodeChip.prototype.toString=function(){return sprintf("[CodeChip %s %s]",this.name,this.methodname)},CodeChip.prototype.reset=function(t){var e
if(this.initial){var i="function"==typeof this.initial?this.initial():this.initial
e=this.method.apply(this.cap.scope,i)}else e=this.method
this.value=this.memoize(e,this.inputs,this.cacheable)},CodeChip.prototype.memoize=function(f,actuals,cacheable){var t0=-1,cache=null,actuals0=null
if(null!=actuals){actuals0=[]
for(var i in actuals)actual=actuals[i],null==actual&&(actual="0"),"function"==typeof actual?actuals0.push(actual):("string"==typeof actual||"number"==typeof actual)&&(eval(sprintf("function aactual(){return %s}",new String(actual).trim())),actuals0.push(aactual))}var g=function(t){if(null!=actuals){var e=new Array
for(var i in actuals0)e[i]=actuals0[i].call(t)
return f.apply(t,e)}return f.apply(t,arguments)}
return function(t,e){return t0==t&&cacheable||(t0=t,cache=g(e)),cache}},Command.prototype=Object.create(comp_proto.prototype),Command.prototype.__defineGetter__("exp",function(){return this._exp}),Command.prototype.__defineSetter__("exp",function(e){this._exp=e,"string"==typeof e?(eval(sprintf("function block(t){%s}",new String(e).trim())),this.value=block):"function"==typeof e&&(this.value=e)}),Command.prototype.reset=function(t){},Command.prototype.toString=function(){return sprintf("[Command %s]",this.name)},Command.prototype.execute=function(t,e){this.value.call(e,t.current)},Command.prototype.constructor=Command,Capsule.prototype=Object.create(comp_proto.prototype),Capsule.prototype.constructor=Capsule,Capsule.prototype.curCap=null,Capsule.prototype.reset=function(t){var e=Capsule.curCap
Capsule.curCap=this,this.clock=t
for(var i=0;i<this.plugins.length;i++)this.plugins[i].prereset(t)
this.scope=new this.scopemaker(t.current)
for(var n=0;n<this.simulators.length;n++)this.simulators[n].isClockedChip()||this.simulators[n].reset(t)
for(var i=0;i<this.resetables.length;i++)this.resetables[i].reset(t)
for(var i=0;i<this.iterables.length;i++)this.iterables[i].reset(t)
for(var i=0;i<this.preplugins.length;i++)this.preplugins[i].reset(t,this.scope)
for(var i=0;i<this.plugins.length;i++)this.plugins[i].reset(t,this.scope)
for(var n=0;n<this.simulators.length;n++)this.simulators[n].isNodeContainer()&&this.simulators[n].connectNodes()
Capsule.curCap=e},Capsule.prototype.iterate=function(t,e,i){this.scope.setTime(t)
var n=Capsule.curCap
if(Capsule.curCap=this,"Euler"==this.clock.method||"RK4"==this.clock.method&&"k0"==e){for(var r=0;r<this.precoms.length;r++)(!this.precoms[r].initCom||this.clock.isFirst())&&(!this.precoms[r].finCom||this.clock.isLast())&&this.precoms[r].execute(this.clock,this.scope)
for(var o=0;o<this.preplugins.length;o++)this.preplugins[o].strobe(this.clock.current,this.scope)
for(var o=0;o<this.preplugins.length;o++)this.preplugins[o].update(this.clock.current,this.scope)}var s=function(){for(var t=0;t<this.iterables.length;t++)integrator(this.clock.method,this.iterables[t],this.clock.current,this.clock.dt,this.scope,e)
Capsule.curCap=n,i()}.bind(this)
kloop(this.simulators,function(i,n){i.iterate(t,e,n,this.clock)}.bind(this),s)},Capsule.prototype.strobe=function(){return this.iterate.apply(this,arguments)},Capsule.prototype.toString=function(){return sprintf("[Capsule %s %s]",this.name,Object.keys(this.components))},Capsule.prototype.postProcess=function(t){this.scope.setTime(t)
for(var e=0;e<this.simulators.length;e++)this.simulators[e].isClockedChip()||this.simulators[e].postProcess(t)
for(var i=0;i<this.plugins.length;i++)this.plugins[i].strobe(this.clock.current,this.scope)
for(var i=0;i<this.plugins.length;i++)this.plugins[i].update(this.clock.current,this.scope)
for(var i=0;i<this.postcoms.length;i++)(!this.postcoms[i].initCom||this.clock.isFirst())&&(!this.postcoms[i].finCom||this.clock.isLast())&&this.postcoms[i].execute(this.clock,this.scope)},Capsule.prototype.terminate=function(){for(var t=0;t<this.postcoms.length;t++)this.postcoms[t].finCom&&this.postcoms[t].execute(this.clock,this.scope)},Capsule.prototype.FLIP=function(t){return Math.random()<t},Capsule.prototype.POISSON=function(t){var e=Math.exp(-t),i=0,n=1
do i++,n=Math.random()*n
while(n>e)
return i-1},ClockedChip.prototype=Object.create(Capsule.prototype),ClockedChip.prototype.strobe=function(){return Capsule.prototype.iterate.apply(this,arguments)},ClockedChip.prototype.iterate=function(t,e,i,n){n.halt(),this.clock.reset(this),this.clock.run(function(){i(),n.restart()})},ClockedChip.prototype.toString=function(){return sprintf("[ClockedChip %s %s]",this.name,Object.keys(this.components))},AgentVector.prototype=Object.create(comp_proto.prototype),AgentVector.prototype.constructor=AgentVector,AgentVector.prototype.strobe=function(){return this.iterate.apply(this,arguments)},AgentVector.prototype.setCap=function(t){comp_proto.prototype.setCap.call(this,t),this.Super=t
for(var e=this.vector,i=0;i<e.length;i++)e[i].setCap(t),e[i].Super=t},AgentVector.prototype.generate=function(t){this.vector=new Array
for(var e=t?Object.keys(t):null,i=0;i<this.count;i++){var n=this.populateOne(i)
if(this.vector.push(n),t){var r=t[e[i]]
n.ix=r.ix,n.iy=r.iy,n.itheta=r.itheta}}this.baseAgentSet=new Array
for(var i in this.vector)this.baseAgentSet[i]=this.vector[i]
this.lastId=this.count},AgentVector.prototype.populateOne=function(t,e){var i
return this.recycle.length>0?(i=this.recycle.pop(),i.clean(),Agent.call(i,i.name,i.components,t)):i=this.capgen(t,Agent),i.agentvector=this,i.Super=this,this.simworld&&(i.simworld=this.simworld,i.mycell=null),i},AgentVector.prototype.regenerate=function(t){if("number"==typeof t?(this.count=t,t=void 0):this.count=Object.keys(t).length,this.generate(t),0!=this.count)if(this.pinsDone)for(var e in this.inpinExps)this.inPinVectorFix(this.inpinExps[e],e)
else{var i=this.vector[0],n=new Object
for(var e in i.inpins)n[e]=this[e]
this.inPinSetup()
for(var e in n)this[e]=n[e]
this.outPinSetup()}},AgentVector.prototype.createAgent=function(t,e){var i=this.lastId++,n=this.populateOne(i)
return n.parent=e.self,n.setCap(this.cap),this.initialize(n,t,e),this.births[i]=n,i},AgentVector.prototype.killAgent=function(t){t.zombie=!0,this.deaths[t.id]=t},AgentVector.prototype.toString=function(){return sprintf("[AgentVector %s %s]",this.name,this.capgen.name)},AgentVector.prototype.MYCELL=function(t){return this.vector[+t].mycell.scope},AgentVector.prototype.X=function(t){return this.vector[+t]?this.vector[+t].x:null},AgentVector.prototype.Y=function(t){return this.vector[+t]?this.vector[+t].y:null},AgentVector.prototype.THETA=function(t){return this.vector[+t]?this.vector[+t].theta:null},AgentVector.prototype.AGENTS=function(t){return this.vector[+t]?this.vector[+t].scope:null},AgentVector.prototype.__defineGetter__("Ids",function(){return Object.keys(this.vector)}),AgentVector.prototype.__defineGetter__("Agentcount",function(){return Object.keys(this.vector).length}),AgentVector.prototype.inPinSetup=function(){if(0!=this.vector.length){var t=this.vector[0]
for(var e in t.inpins)this.__defineGetter__(e,function(t){return function(){return this.inpinExps[t]}}(e)),this.__defineSetter__(e,function(t){return function(e){this.inpinExps[t]=e,this.inPinVectorFix(e,t)}}(e))
this.pinsDone=!0}},AgentVector.prototype.inPinVectorFix=function(t,e){for(j in this.vector)this.inPinFix(t,e,this.vector[j])},AgentVector.prototype.inPinFix=function(t,e,i){var n=i.id
"string"==typeof t||"number"==typeof t?i.inpins[e].exp=sprintf("(function(myId){return %s;}).call(this, %d)",new String(t).trim(),n):"function"==typeof t&&(i.inpins[e].exp=function(){return t.call(this,this.id)})},AgentVector.prototype.outPinSetup=function(){if(0!=this.vector.length){var t=this.vector[0]
for(var e in t.outpins)this.__defineGetter__(e,function(t){return function(){return function(e){return this.vector[e].scope[t]}.bind(this)}}(e))}},AgentVector.prototype.initialize=function(t,e,i){e||(e=i),t.ix=void 0!=e.x?e.x:i.x,t.iy=void 0!=e.y?e.y:i.y,t.itheta=void 0!=e.theta?e.theta:i.theta,t.x=t.ix,t.y=t.iy,t.theta=t.itheta
for(var n in e){var r=e[n]
if(t.components.hasOwnProperty(n)){var o=t.components[n]
o.isIterable()||o.isLVariable()?o.initial=r:o.exp=r}}for(var n in this.inpinExps)this.inPinFix(this.inpinExps[n],n,t)},AgentVector.prototype.iterate=function(t,e,i){for(var n in this.changes)this.changes[n]=[]
kloop(this.vector,function(i,n){i.iterate(t,e,n)},i)},AgentVector.prototype.terminate=function(){for(var t in this.vector)this.vector[t].terminate()},AgentVector.prototype.postProcess=function(t){this.scope.setTime(t)
for(var e in this.vector)this.vector[e].postProcess(t)
for(var e in this.births){var i=this.births[+e]
this.vector[+e]=i,i.reset(this.clock)}for(var e in this.deaths)this.vector[+e].id>=this.count&&this.recycle.push(this.vector[+e]),delete this.vector[+e]
this.changes._births_=Object.keys(this.births),this.changes._deaths_=Object.keys(this.deaths),this.deaths={},this.births={}},AgentVector.prototype.reset=function(t){delete this.vector,delete this.recycle,this.clock=t,this.vector=new Array,this.recycle=new Array,this.scopemaker=scopemaker([],this),this.scope=new this.scopemaker(t.current)
var e=this.count,i=this.scope.Init_Count
if(null!=i?this.count="function"==typeof i?i.call(this.scope):i:null!=this.counter&&(this.count="function"==typeof this.counter?this.counter().call(this.scope):this.counter),e==this.count)for(var n in this.baseAgentSet)this.vector[n]=this.baseAgentSet[n],this.vector[n].clean()
else this.recycle=this.baseAgentSet,this.regenerate(this.count),this.lastId=this.count
if(this.changes=new Object,this.changes.location=[],this.births={},this.deaths={},this.moved=new Array,0!=this.vector.length){this.changes._births_=[],this.changes._deaths_=[]
for(var r in this.vector[0].outDataNames){var o=this.vector[0].outDataNames[r]
"x"!=o&&"y"!=o&&(this.changes[o]=[])}this.vscopes=[]
for(var n in this.vector)this.vector[n].reset(t),this.vscopes[n]=this.vector[n].scope}},AgentVector.prototype.register=function(t,e){this.changes[t].push(e.id),"location"==t&&this.moved.push(e)},AgentVector.prototype.putAgentInCell=function(t,e){t.mycell=e},AgentVector.prototype.INBOUNDS=function(t,e){var i=nsutil.coordsOrNum(t,e),n=i[0],r=i[1]
return r>=0&&r<this.rows&&n>=0&&n<this.cols},Agent.prototype=Object.create(Capsule.prototype),Agent.prototype.constructor=Agent,Agent.prototype.toString=function(){return sprintf("[Agent %s %s]",this.name,Object.keys(this.components))},Agent.prototype.clean=function(){this.ix=null,this.iy=null},Agent.prototype.reset=function(t){Capsule.prototype.reset.call(this,t),this.birth=this.clock.current,this.outPinData=new Object,this.agentvector.simworld&&(this.mycell=null),this.x=this.ix?this.ix:this.init_x?this.init_x.value(t.lo):0,this.y=this.iy?this.iy:this.init_y?this.init_y.value(t.lo):0,this.theta=this.itheta?this.itheta:this.init_theta?this.init_theta.value(t.lo):0,this.ix=this.x,this.iy=this.y,this.itheta=this.theta,this.zombie=!1
var e=!1
for(var i in this.outDataNames){var n=this.outDataNames[i],r=n
if(this.outPinData[n]=this.scope[n],"x"==n||"y"==n){if(e)continue
e=!0,r="location"}this.agentvector.register(r,this)}},Agent.prototype.iterate=function(t,e,i){this.zombie&&i(),Capsule.prototype.iterate.call(this,t,e,i)},Agent.prototype.postProcess=function(t,e){Capsule.prototype.postProcess.call(this,t,e)
var i=!1
for(var n in this.outDataNames){var r=this.outDataNames[n],o=r
if(this.outPinData[r]!=this.scope[r]){if(this.outPinData[r]=this.scope[r],"x"==r||"y"==r){if(i)continue
i=!0,o="location"}else o=r
this.agentvector.register(o,this)}}},Agent.prototype.MYCELL=function(t){return 0==arguments.length?this.mycell.scope:this.agentvector.MYCELL(t).scope},Agent.prototype.MOVETO=function(t,e){if(t!=this.self.x||e!=this.self.y){var i=nsutil.coordsOrNum(e,t)
e=i[0],t=i[1],this.self.x=nsutil.wrap(t,this.agentvector.cols),this.self.y=nsutil.wrap(e,this.agentvector.rows),this.self.wrapped=this.x!=t||this.y!=e}},Agent.prototype.MOVEPLUS=function(t,e){var i=nsutil.coordsOrNum(e,t)
e=i[0],t=i[1]
var n=this.self.x+t,r=this.self.y+e
this.self.x=nsutil.wrap(n,this.agentvector.cols),this.self.y=nsutil.wrap(r,this.agentvector.rows),this.self.wrapped=this.x!=n||this.y!=r},Agent.prototype.MOVEPLUSR=function(t){var e=this.self.x+t*Math.cos(this.theta),i=this.self.y+t*Math.sin(this.theta)
this.self.x=nsutil.wrap(e,this.agentvector.cols),this.self.y=nsutil.wrap(i,this.agentvector.rows),this.self.wrapped=this.x!=e||this.y!=i},Agent.prototype.NEWTHETA=function(t){this.self.theta=nsutil.math.normalize(t)},Agent.prototype.CELL=function(t,e){var i=nsutil.coordsOrNum(t,e)
return this.agentvector.simworld.cellmatrix.matrix[Math.floor(i[0])][Math.floor(i[1])].scope},Agent.prototype.AGENTS=function(t){return this.agentvector.vector[t].scope},Agent.prototype.AGENTBLOCK=function(t){var e=this.mycell.BLOCK(t),i=new Array
for(var n in e){var r=this.CELL(e[n]).myagents,o=Object.keys(r)
for(var s in o)i.push(r[o[s]].scope)}return i},Agent.prototype.DISTANCE_TO=function(t){var e="object"==typeof t?t:this.agentvector.vector[t]
return null==e?infinity:nsutil.math.distance(this,e)},Agent.prototype.IN_RADIUS=function(t){var e,i=new Array
for(var n in this.agentvector.vector)n!=this.id&&(e=this.DISTANCE_TO(n))<=t&&i.push({id:n,distance:e})
return i.sort(function(t,e){return t.distance-e.distance}),i},Agent.prototype.BOUNCE=function(t){var e=this.self.x,i=this.self.y,n=nsutil.math.normalize(t),r=this.agentvector.rows,o=this.agentvector.cols,s=e>1&&o-1>e&&i>1&&r-1>i?n:1>=e&&(n>nsutil.math.pio2||n<nsutil.math.mpio2)||e>=o-1&&n>nsutil.math.mpio2&&n<nsutil.math.pio2?nsutil.math.normalize(nsutil.math.pi-n):2>=i&&n>=nsutil.math.mpi&&0>=n||i>=r-1&&n>=0&&n<=nsutil.math.pi?nsutil.math.normalize(-n):n
return s},Agent.prototype.CREATE=function(t,e){if(0==e)return null
if(void 0==e||1==e){var i=this.agentvector.createAgent(t,this)
return i}for(var n=[],r=0;e>r;r++)n.push(this.agentvector.createAgent(t,this))
return n},Agent.prototype.KILL=function(t){this.agentvector.vector[t]&&this.agentvector.killAgent(this.agentvector.vector[t])},Agent.prototype.SOME_AGENT=function(t,e,i){return t.some(function(t){return t[e]==i})},AgentVector.prototype.X=function(t){return this.vector[+t]?this.vector[+t].x:null},Agent.prototype.RANDOM_MOVE=function(){var t=this.self.x,e=this.self.y
if(void 0==t||void 0==e)return{x:x,y:y}
for(var i=t,n=e;;){var r=Math.random(),o=.33333>r?-1:.66666>r?0:1,s=Math.random(),p=.33333>s?-1:.66666>s?0:1
if(i=t+o,n=e+p,this.agentvector.INBOUNDS(i,n))return new Object({x:i,y:n})}},Agent.prototype.__defineGetter__("rows",function(){return this.agentvector.rows}),Agent.prototype.__defineGetter__("cols",function(){return this.agentvector.rows}),Agent.prototype.__defineGetter__("mycoords",function(){return{col:Math.floor(this.self.x),row:Math.floor(this.self.y)}}),Agent.prototype.__defineGetter__("Location",function(){return{x:this.self.x,y:this.self.y,theta:this.self.theta}}),Agent.prototype.__defineGetter__("Agentcount",function(){return this.agentvector.Agentcount}),CellMatrix.prototype=Object.create(comp_proto.prototype),CellMatrix.prototype.constructor=CellMatrix,CellMatrix.prototype.strobe=function(){return this.iterate.apply(this,arguments)},CellMatrix.prototype.toString=function(){return sprintf("[CellMatrix %s %s]",this.name,this.capgen.name)},CellMatrix.prototype.setCap=function(t){comp_proto.prototype.setCap.call(this,t),this.Super=t
for(var e=this.matrix,i=0;i<e.length;i++)for(var n=0;n<e[i].length;n++)e[i][n].setCap(t),e[i][n].Super=t},CellMatrix.prototype.CELLS=function(t,e){if(0==arguments.length){for(var i=new Array,n=this.matrix,t=0;t<n.length;t++){i[t]=new Array
for(var e=0;e<n[t].length;e++)i[t][e]=n[t][e].scope}return i}return void 0==e?this.cellsById[t].scope:this.matrix[t][e].scope}
var CELL=function(t,e){return Capsule.curCap.CELL(t,e)}
CellMatrix.prototype.CELL=CellMatrix.prototype.CELLS,CellMatrix.prototype.inPinSetup=function(){if(0!=this.matrix.length){var t=this.matrix[0][0]
for(var e in t.inpins)this.__defineGetter__(e,function(t){return function(){return this.inpinExps[t]}}(e)),this.__defineSetter__(e,function(t){return function(e){this.inpinExps[t]=e,this.inPinNodesFix(e,t)}}(e))}},CellMatrix.prototype.inPinNodesFix=function(t,e){for(i in this.matrix)for(j in this.matrix[i])this.inPinFix(t,e,this.matrix[i][j])},CellMatrix.prototype.inPinFix=function(t,e,n){n.id
"string"==typeof t||"number"==typeof t?n.inpins[e].exp=sprintf("(function(coords){return %s;}).call(this, {row: %d, col:%d})",new String(t).trim(),i,j):"function"==typeof t&&(n.inpins[e].exp=function(){return t.call(this,{row:this.row,col:this.col})})},CellMatrix.prototype.outPinSetup=function(){if(0!=this.matrix.length){var t=this.matrix[0][0]
for(var e in t.outpins)this.__defineGetter__(e,function(t){return function(){return function(e,i){return this.matrix[e][i].scope[t]}.bind(this)}}(e))}},CellMatrix.prototype.iterate=function(t,e,i){for(var n in this.changes)this.changes[n]=[]
for(var r=this.matrix,o=function(){},s=0;s<r.length;s++)for(var p=0;p<r[s].length;p++)r[s][p].iterate(t,e,o)
i()},CellMatrix.prototype.terminate=function(){for(i in this.matrix)for(j in this.matrix[i])this.matrix[i][j].terminate()},CellMatrix.prototype.postProcess=function(t){this.scope.setTime(t)
for(i in this.matrix)for(j in this.matrix[i])this.matrix[i][j].postProcess(t)},CellMatrix.prototype.reset=function(t){if(this.clock=t,this.scopemaker=scopemaker([],this),this.scope=new this.scopemaker(t.current),this.changes=new Object,0!=this.matrix.length){for(var e in this.matrix[0][0].outpins)this.changes[e]=[]
for(i in this.matrix)for(j in this.matrix[i])this.matrix[i][j].reset(t)}},CellMatrix.prototype.addAgentToCell=function(t){var e=this.matrix[Math.floor(t.y)][Math.floor(t.x)]
return e.myagents[t.id]=t,e},CellMatrix.prototype.deleteAgentFromCell=function(t){var e=t.mycell
delete e.myagents[t.id]},Cell.prototype=Object.create(Capsule.prototype),Cell.prototype.toString=function(){return sprintf("[Cell %s %s]",this.name,Object.keys(this.components))},Cell.prototype.constructor=Cell,Cell.prototype.reset=function(t){Capsule.prototype.reset.call(this,t),this.outPinData=new Object,this.cellmatrix.simworld&&(this.myagents=new Object)
for(var e in this.outpins)this.outPinData[e]=this.scope[e],this.cellmatrix.changes[e].push(this.id)},Cell.prototype.postProcess=function(t,e){Capsule.prototype.postProcess.call(this,t,e)
for(var i in this.outpins)this.outPinData[i]!=this.scope[i]&&(this.outPinData[i]=this.scope[i],this.cellmatrix.changes[i].push(this.id))},Cell.prototype.CELLS=function(t,e){for(var i=new Array,n=this.cellmatrix.matrix,t=0;t<n.length;t++){i[t]=new Array
for(var e=0;e<n[t].length;e++)i[t][e]=n[t][e].scope}return i},Cell.prototype.CELL=function(t,e){var i=nsutil.coordsOrNum(t,e)
return this.cellmatrix.matrix[i[0]][i[1]].scope},Cell.prototype.CELL_VALUE=function(t,e,i){var n=nsutil.coordsOrNum(t,e)
return this.cellmatrix.matrix[n[0]][n[1]].scope[i]},Cell.prototype.MYAGENTS=function(t,e){var i=this
return 0==arguments.length?Object.keys(this.myagents).map(function(t){return i.myagents[t].scope}):this.CELL(t,e).MYAGENTS()},Cell.prototype.MYAGENT_COUNT=function(t,e){return 0==arguments.length?Object.keys(this.myagents).length:this.CELL(t,e).MYAGENT_COUNT()},Cell.prototype.RING=function(t){var e=new Array
if(this.row-t>0)for(var i=this.row-t,n=this.col-t;n<=this.col+t;n++)0>n||n>=this.cols||e.push({row:i,col:n})
if(this.col+t<this.cols)for(var n=this.col+t,i=this.row-t+1;i<=this.row+t;i++)0>i||i>=this.rows||e.push({row:i,col:n})
if(this.row+t<this.rows)for(var i=this.row+t,n=this.col+t-1;n>=this.col-t;n--)0>n||n>=this.cols||e.push({row:i,col:n})
if(this.col-t>=0)for(var n=this.col-t,i=this.row+t-1;i>this.row-t;i--)0>i||i>=this.rows||e.push({row:i,col:n})
return e},Cell.prototype.WRING=function(t){for(var e=new Array,i=nsutil.wrap(this.row-t,this.rows),n=this.col-t;n<=this.col+t;n++)e.push({row:i,col:nsutil.wrap(n,this.cols)})
for(var n=nsutil.wrap(this.col+t,this.cols),i=this.row-t+1;i<=this.row+t;i++)e.push({row:nsutil.wrap(i,this.rows),col:n})
i=nsutil.wrap(this.row+t,this.rows)
for(var n=this.col+t-1;n>=this.col-t;n--)e.push({row:i,col:nsutil.wrap(n,this.cols)})
n=nsutil.wrap(this.col-t,this.cols)
for(var i=this.row+t-1;i>this.row-t;i--)e.push({row:nsutil.wrap(i,this.rows),col:n})
return e},Cell.prototype.BLOCK=function(t){for(var e=new Array,i=this.row-t;i<=this.row+t;i++)for(var n=this.col-t;n<=this.col+t;n++)0>i||i>=this.rows||0>n||n>=this.cols||e.push({row:i,col:n})
return e},Cell.prototype.WBLOCK=function(t){for(var e=new Array,i=this.row-t;i<=this.row+t;i++)for(var n=this.col-t;n<=this.col+t;n++)e.push({row:i,col:n})
return e},Cell.prototype.__defineGetter__("coords",function(){return{row:this.row,col:this.col}}),Cell.prototype.__defineGetter__("rows",function(){return this.cellmatrix.rows}),Cell.prototype.__defineGetter__("cols",function(){return this.cellmatrix.cols}),NodeNetwork.prototype=Object.create(comp_proto.prototype),NodeNetwork.prototype.constructor=NodeNetwork,NodeNetwork.prototype.setCap=function(t){comp_proto.prototype.setCap.call(this,t),this.Super=t
for(var e=this.nodes,i=0;i<e.length;i++)e[i].setCap(t),e[i].Super=t},NodeNetwork.prototype.strobe=function(){return this.iterate.apply(this,arguments)},NodeNetwork.prototype.toString=function(){return sprintf("[NodeNetwork %s %s]",this.name,this.capgen.name)},NodeNetwork.prototype.NODES=function(t){return this.nodes[t].scope},NodeNetwork.prototype.CONNECTION=function(t,e){return this.nodes[t].connexions_out[e]},NodeNetwork.prototype.CONNECTIONS_OUT=function(t){return this.nodes[i].connexions_out},NodeNetwork.prototype.CONNECTIONS_IN=function(t){return this.nodes[i].connexions_in},NodeNetwork.prototype.OUTFLOW=function(t){return this.nodes[i].outStrength},NodeNetwork.prototype.INFLOW=function(t){return this.nodes[i].inStrength},NodeNetwork.prototype.inPinSetup=function(){if(0!=this.nodes.length){var t=this.nodes[0]
for(var e in t.inpins)this.__defineGetter__(e,function(t){return function(){return this.inpinExps[t]}}(e)),this.__defineSetter__(e,function(t){return function(e){this.inpinExps[t]=e,this.inPinNodesFix(e,t)}}(e))}},NodeNetwork.prototype.inPinNodesFix=function(t,e){for(j in this.nodes)this.inPinFix(t,e,this.nodes[j])},NodeNetwork.prototype.inPinFix=function(t,e,i){var n=i.id
"string"==typeof t||"number"==typeof t?i.inpins[e].exp=sprintf("(function(myId){return %s;}).call(this, %d)",new String(t).trim(),n):"function"==typeof t&&(i.inpins[e].exp=function(){return t.call(this,this.id)})},NodeNetwork.prototype.outPinSetup=function(){if(0!=this.nodes.length){var t=this.nodes[0]
for(var e in t.outpins)this.__defineGetter__(e,function(t){return function(){var e=this
return function(i){return e.nodes[i].scope[t]}.bind(this)}}(e))}},NodeNetwork.prototype.iterate=function(t,e,i){for(var n in this.changes)this.changes[n]=[]
kloop(this.nodes,function(i,n){i.iterate(t,e,n)},i)},NodeNetwork.prototype.terminate=function(){for(i in this.nodes)this.nodes[i].terminate()},NodeNetwork.prototype.postProcess=function(t){this.scope.setTime(t)
for(i in this.nodes)this.nodes[i].postProcess(t)},NodeNetwork.prototype.reset=function(t){if(this.clock=t,this.scopemaker=scopemaker([],this),this.scope=new this.scopemaker(t.current),this.changes=new Object,0!=this.nodes.length){for(var e in this.nodes[0].outpins)this.changes[e]=[]
for(i in this.nodes)Capsule.prototype.reset.call(this.nodes[i],t)
for(i in this.nodes)this.nodes[i].reset(t)}},NodeNetwork.prototype.connectNodes=function(){if(this.fstTime){this.fstTime=!1
for(i in this.nodes){var t=this.nodes[i]
t.connexions_in=new Array,t.connexions_out=new Array,t.outStrength=0,t.inStrength=0}this.connexions=new Array
for(i in this.nodes)this.nodes[i].connectUp(this.nodes,this.nconnect,this.connexions)
for(i in this.nodes)this.nodes[i].normalizeConnexions()}},NodeNetwork.prototype.addAgentToNode=function(t){var e=this.nodes[Math.floor(t.mynode)]
return e.myagents[t.id]=t,e},NodeNetwork.prototype.deleteAgentFromNode=function(t){var e=t.mynode
delete e.myagents[t.id]},Node.prototype=Object.create(Capsule.prototype),Node.prototype.toString=function(){return sprintf("[Node %s %s]",this.name,Object.keys(this.components))},Node.prototype.constructor=Node,Node.prototype.reset=function(t){this.outPinData=new Object,this.nodenetwork.networld&&(this.myagents=new Object)
for(var e in this.outpins)this.outPinData[e]=this.scope[e],this.nodenetwork.changes[e].push(this.id)},Node.prototype.postProcess=function(t,e){Capsule.prototype.postProcess.call(this,t,e)
for(var i in this.outpins)this.outPinData[i]!=this.scope[i]&&(this.outPinData[i]=this.scope[i],this.nodenetwork.changes[i].push(this.id))},Node.prototype.normalizeConnexions=function(){var t=this.outStrength
for(var e in this.connexions_out){var i=this.connexions_out[e]
i.n_strength=i.strength/t}},Node.prototype.connectUp=function(t,e,i){for(var n in t){var r=t[n]
if(r.id!=this.id){var o=e.call(this.scope,this.id,r.id)
if(0!=o){var s={source:this.id,target:r.id,strength:o}
i.push(s),this.connexions_out[r.id]=s,this.outStrength+=o,r.connexions_in[this.id]=s,r.inStrength+=o}}}},Node.prototype.NODE=function(t){return this.nodenetwork.nodes[t].scope},Node.prototype.MYAGENTS=function(t){var e=this
return 0==arguments.length?Object.keys(this.myagents).map(function(t){return e.myagents[t].scope}):this.NODE(t).MYAGENTS()},Node.prototype.MYAGENT_COUNT=function(t){return 0==arguments.length?Object.keys(this.myagents).length:this.NODE(t).MYAGENT_COUNT()},Node.prototype.NODES=function(t){return this.nodenetwork.NODES(t)},Node.prototype.CONNECTION=function(t,e){return this.nodenetwork.CONNECTION(t,e)},Node.prototype.CONNECTIONS_OUT=function(t){return this.nodenetwork.CONNECTIONS_OUT(t)},Node.prototype.CONNECTIONS_IN=function(t){return this.nodenetwork.CONNECTIONS_IN(t)},Node.prototype.OUTFLOW=function(t){return this.nodenetwork.OUTFLOW(t)},Node.prototype.INFLOW=function(t){return this.nodenetwork.INFLOW(t)},Simworld.prototype=Object.create(comp_proto.prototype),Simworld.prototype.constructor=Simworld,Simworld.prototype.setCap=function(t){comp_proto.prototype.setCap.call(this,t),this.Super=t,this.cellmatrix.setCap(t),this.agentvector.setCap(t)},Simworld.prototype.strobe=function(){return this.iterate.apply(this,arguments)},Simworld.prototype.toString=function(){return sprintf("[Simworld %s %s %s]",this.name,this.agentgen.name,this.cellgen.name)},Simworld.prototype.MYCELL=function(t){return this.agentvector.vector[t].mycell.scope},Simworld.prototype.MYAGENTS=function(t,e){return this.cellmatrix.matrix[t][e].MYAGENTS()},Simworld.prototype.reset=function(t){this.scopemaker=scopemaker([],this),this.scope=new this.scopemaker(t.current),this.agentvector.reset(t),this.cellmatrix.reset(t)
for(var e in this.agentvector.moved){var i=this.agentvector.moved[e],n=this.cellmatrix.addAgentToCell(i)
this.agentvector.putAgentInCell(i,n)}this.agentvector.moved=new Array},Simworld.prototype.iterate=function(t,e,i){this.agentvector.iterate(t,e,function(){this.cellmatrix.iterate(t,e,i)}.bind(this))},CellMatrix.prototype.terminate=function(){this.agentvector.terminate(),this.cellmatrix.terminate()},Simworld.prototype.postProcess=function(t){this.scope.setTime(t),this.agentvector.postProcess(t),this.cellmatrix.postProcess(t)
for(var e in this.agentvector.moved){var i=this.agentvector.moved[e]
this.cellmatrix.deleteAgentFromCell(i)
var n=this.cellmatrix.addAgentToCell(i)
this.agentvector.putAgentInCell(i,n)}this.agentvector.moved=new Array},Simworld.prototype.__defineGetter__("AGENTS",function(){return this.agentvector.AGENTS}),Simworld.prototype.__defineGetter__("CELLS",function(){return this.agentvector.CELLS}),Clock.prototype.stack=new Array,Clock.prototype.reset=function(t){this.current=this.lo,this.flag=!1,this.k=null,t&&(this.simulator=t),this.simulator.reset(this)},Clock.prototype.stop=function(){this.flag=!0},Clock.prototype.step=function(t){var e=function(){this.current+=this.dt,this.simulator.postProcess(this.current),t&&t()}.bind(this)
switch(this.method){case"Euler":this.simulator.strobe(this.current,this.epochs[0],e)
break
case"RK4":var i=[this.current,this.current+this.dt/2,this.current+this.dt/2,this.current+this.dt]
kloop(this.epochs,function(t,e,n){this.simulator.strobe(i[n],t,e)}.bind(this),e)}},Clock.prototype.terminate=function(){this.simulator.terminate()},Clock.prototype.epochs=["k0","k1","k2","k3"],Clock.prototype.runAll=function(){this.isRunAll=!0
for(var t=0==arguments.length?this.hi:arguments[0],e=this.current;e<=t-this.dt;e+=this.dt)this.step()
this.isRunAll=!1},Clock.prototype.run=function(){if(!this.running){var t=arguments.length<=1?this.hi:arguments[1]
this.quitter=function(){return this.flag||this.current>t-this.dt}.bind(this),this.timer=null,this.k=arguments[0],this.everyk=arguments[2],this.ping=function(){return this.quitter()?(this.running=!1,Clock.curClock=null,clearInterval(this.timer),this.k&&this.k.call(this.simulator.scope),this.domultirun=!1,this.newspeed=!1,!0):(this.step(this.iterate),this.everyk&&this.everyk.call(this.simulator.scope),this.newspeed&&!this.domultirun&&(this.newspeed=!1,this.runit()),!1)}.bind(this),this.running=!0,Clock.curClock=this,this.runit()}},Clock.prototype.multirun=function(){for(var t=0;t<this.postInterval;t++)if(this.ping())return void(this.domultirun=!1)},Clock.prototype.restart=function(){Clock.curClock=this,this.runit()},Clock.prototype.cont=function(){this.running||null==this.timer||(this.flag=!1,this.running=!0,this.runit())},Clock.prototype.runit=function(){clearInterval(this.timer),this.postInterval>0?(this.domultirun=!0,this.timer=setInterval(this.multirun.bind(this),0)):this.timer=setInterval(this.ping,this.speed)},Clock.prototype.halt=function(){clearInterval(this.timer),this.running=!1},Clock.prototype.isFirst=function(){return this.current==this.lo},Clock.prototype.isLast=function(){return Math.abs(this.current-this.hi)<.001||this.current-.001>this.hi-this.dt},Clock.prototype.resetIterate=function(){delete this.iterate},Clock.prototype.setSpeed=function(t){this.speed=t},Clock.prototype.process=function(){for(var t=0==arguments.length?this.hi:arguments[0];this.current<=t-this.dt&&!this.flag;)this.step()},Clock.prototype.toString=function(){return sprintf("[Clock %f %f %f %s]",this.lo,this.hi,this.dt,this.method)},Clock.prototype.getArg=function(t){return"number"==typeof t?t:+t.value}
var nsutil={math:{pi:Math.PI,pio2:Math.PI/2,mpio2:-Math.PI/2,mpi:-Math.PI,pi2:2*Math.PI,normalize:function(t){var e=t%this.pi2
return e>this.pi?e-=this.pi2:e<=this.mpi&&(e+=this.pi2),e},distance:function(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}},wrap:function(t,e){return t>=0&&e>t?t:(t%e+e)%e},interpolate:function(t,e){if(void 0!=e[t])return e[t]
var i=Object.keys(e)
if(t<i[0])return e[0]
if(t>i[i.length-1])return e[i[i.length-1]]
var n,r,o=nsutil.binaryIndexOf(i,t)
return i[o]>t?(r=i[o],n=i[o-1]):(r=i[o+1],n=i[o]),e[n]+(e[r]-e[n])/(r-n)*(t-n)},binaryIndexOf:function(t,e){for(var i,n,r=0,o=t.length-1;o>=r;)if(i=Math.floor((r+o)/2),n=+t[i],e>n)r=i+1
else{if(!(n>e))return i
o=i-1}return i},coordsOrNum:function(t,e){if("number"==typeof t&&"number"==typeof e)return[t,e]
if(Array.isArray(t))return t
if("object"==typeof t){if("row"in t||"col"in t)return[t.row,t.col]
if("x"in t||"y"in e)return[t.y,t.x]}},collect:function(){for(var t={},e=arguments.length,i=0;e>i;i++)for(p in arguments[i])arguments[i].hasOwnProperty(p)&&(t[p]=arguments[i][p])
return t},request:function(url,callback){var req=new XMLHttpRequest
req.open("GET",url,!0),req.setRequestHeader("Accept","application/js"),req.onreadystatechange=function(){4===req.readyState&&(req.status<300?callback(null,eval(req.responseText)):callback(req.status))},req.send(null)},download:function(t,e){var i=new Blob([t],{type:"text/csv"}),n=document.createElement("a")
n.download=e,n.innerHTML="Download File",null!=window.webkitURL?n.href=window.webkitURL.createObjectURL(i):(n.href=window.URL.createObjectURL(i),n.onclick=function(t){document.body.removeChild(t.target)},n.style.display="none",document.body.appendChild(n)),n.click()},sortPlugins:function(t){var e=function(t){switch(t.pluginType){case"Tabulator":return 0
default:return 100}}
return _.sortBy(t,e)}},RANDOM=Math.random
Capsule.prototype.RANDOM=RANDOM
var BINOMIAL=function(t,e){for(var i=0,n=0;t>n;n++)Math.random()<e&&i++
return i}
Capsule.prototype.BINOMIAL=BINOMIAL
var STEP=function(t,e){return Clock.curClock.current>e?t:0}
Capsule.prototype.STEP=STEP
var NORMAL=function(t,e){var i,n,r
do i=2*Math.random()-1,n=2*Math.random()-1,r=i*i+n*n
while(r>=1||0==r)
var o=Math.sqrt(-2*Math.log(r)/r)
return e*(i*o)+t}
Capsule.prototype.NORMAL=NORMAL
var TOTAL=function(t,e){var i=0
for(var n in e)i+=t.call(this,e[n])
return i}
Capsule.prototype.TOTAL=TOTAL
var COUNT=function(t,e){return TOTAL.call(this,function(e){return t(e)?1:0},e)}
Capsule.prototype.COUNT=COUNT
var Schema=function(){var t=new Object
this.defineSchema=function(e,i){t[e]=i},this.getSchema=function(e){return t[e]}},currentSchema=new Schema,NovaManager=function(t,e,i,n,r,o,s,p,c){return function(){var s={runStatus:{running:!1,stopped:!1,reset:!1,terminated:!1},timeField:n,delay:p,clocklo:i.lo,clockhi:+r.value,clockdt:"number"==typeof o?o:"valueAsNumber"in o?o.valueAsNumber:+o.value,clockmethod:i.method,fixSpeed:function(t){i.speed=t,i.newspeed=!0},fixClock:function(t,e){s["clock"+t]=e},step:function(){s.runStatus.running||i.current>=i.hi||(s.runStatus.reset=!1,i.flag=!1,i.run(null,i.current+i.dt),s.runStatus.stopped=!0)},iterate:function(e){s.timeField.value=i.current,t()},terminate:function(){s.runStatus.running=!1,s.runStatus.stopped=!0,s.runStatus.terminated?i.stop():(s.runStatus.terminated=!0,i.terminate())},stop:function(){s.runStatus.running=!1,s.runStatus.stopped=!0,i.stop()},restart:function(){s.runStatus.terminated||s.runStatus.running||(s.runStatus.stopped?(i.flag=!1,i.run(null)):s.run())},reset:function(t){i.halt(),s.runStatus.terminated=!1,s.runStatus.running=!1,s.runStatus.reset=!0,i.lo=s.clocklo,i.hi=r.valueAsNumber,i.dt="number"==typeof o?o:"valueAsNumber"in o?o.valueAsNumber:+o.value,i.method=s.clockmethod,"fast"==t?(i.isRunAll=!0,i.resetIterate()):i.iterate=s.iterate,s.timeField.value=i.lo,e(t)},run:function(){s.runStatus.reset||s.reset(),s.runStatus={running:!0,stopped:!1,reset:!1,terminated:!1},i.run(null)},showSliderValue:function(t,e){var i=document.getElementById(t)
i.value=e},needReset:function(){s.runStatus.reset=!1},noReset:function(){s.runStatus.reset=!0}}
return s.timeField.value=i.lo,i.iterate=s.iterate,c&&(i.cleanup=c),{step:s.step,stop:s.stop,terminate:s.terminate,restart:s.restart,reset:s.reset,run:s.run,fixSpeed:s.fixSpeed,showSliderValue:s.showSliderValue,needReset:s.needReset,fixClock:s.fixClock,clock:i}}()}
sprintfWrapper={init:function(){if("undefined"==typeof arguments)return null
if(arguments.length<1)return null
if("string"!=typeof arguments[0])return null
if("undefined"==typeof RegExp)return null
for(var t=arguments[0],e=new RegExp(/(%([%]|(\-)?(\+|\x20)?(0)?(\d+)?(\.(\d)?)?([bcdfosxX])))/g),i=new Array,n=new Array,r=0,o=0,s=0,p=0,c="",a=null;a=e.exec(t);)a[9]&&(r+=1),o=p,s=e.lastIndex-a[0].length,n[n.length]=t.substring(o,s),p=e.lastIndex,i[i.length]={match:a[0],left:a[3]?!0:!1,sign:a[4]||"",pad:a[5]||" ",min:a[6]||0,precision:a[8],code:a[9]||"%",negative:parseInt(arguments[r])<0?!0:!1,argument:String(arguments[r])}
if(n[n.length]=t.substring(p),0==i.length)return t
if(arguments.length-1<r)return null
var a=null,u=null
for(u=0;u<i.length;u++)"%"==i[u].code?substitution="%":"b"==i[u].code?(i[u].argument=String(Math.abs(parseInt(i[u].argument)).toString(2)),substitution=sprintfWrapper.convert(i[u],!0)):"c"==i[u].code?(i[u].argument=String(String.fromCharCode(parseInt(Math.abs(parseInt(i[u].argument))))),substitution=sprintfWrapper.convert(i[u],!0)):"d"==i[u].code?(i[u].argument=String(Math.abs(parseInt(i[u].argument))),substitution=sprintfWrapper.convert(i[u])):"f"==i[u].code?(i[u].argument=String(Math.abs(parseFloat(i[u].argument)).toFixed(i[u].precision?i[u].precision:6)),substitution=sprintfWrapper.convert(i[u])):"o"==i[u].code?(i[u].argument=String(Math.abs(parseInt(i[u].argument)).toString(8)),substitution=sprintfWrapper.convert(i[u])):"s"==i[u].code?(i[u].argument=i[u].argument.substring(0,i[u].precision?i[u].precision:i[u].argument.length),substitution=sprintfWrapper.convert(i[u],!0)):"x"==i[u].code?(i[u].argument=String(Math.abs(parseInt(i[u].argument)).toString(16)),substitution=sprintfWrapper.convert(i[u])):"X"==i[u].code?(i[u].argument=String(Math.abs(parseInt(i[u].argument)).toString(16)),substitution=sprintfWrapper.convert(i[u]).toUpperCase()):substitution=i[u].match,c+=n[u],c+=substitution
return c+=n[u]},convert:function(t,e){e?t.sign="":t.sign=t.negative?"-":t.sign
var i=t.min-t.argument.length+1-t.sign.length,n=new Array(0>i?0:i).join(t.pad)
return t.left?"0"==t.pad||e?t.sign+t.argument+n.replace(/0/g," "):t.sign+t.argument+n:"0"==t.pad||e?t.sign+n+t.argument:n+t.sign+t.argument}},sprintf=sprintfWrapper.init
