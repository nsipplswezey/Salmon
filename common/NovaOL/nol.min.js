//NovaOL.js 0.0.1
//Nova Online html builder functions
//http://novamodeler.com
//(c) 2014-2015 Richard Salter
// globl is a single namespace for all projects and instances
//nmify (tag) provides properly annotated prefix (suffix) to prepend (append) to references
//timefield returns data describing the textfield displaying the current time
//simcontrols returns data describing the standard simulation control set
//simbuttons returns data describing the standard button set
//control creates appropriate HTML for each type of control
// buttons creates HTML for the standard button set
// populate reads the PData specification and creates appropriate HTML elements
// 	if ("wallpaper" in this.data) {
// 		d3.select("body")
// 		.attr("background", "common/images/"+this.gitn(this.data.wallpaper));
// 	}
// 	else if ("background_color" in this.data) {
// 		d3.select("body")
// 		.style("background-color", this.gitn(this.data.background_color));
// 	}
//A neat way to pass parameters to a script; used to read in the project name to .json script
//Reads in project name and records JSON file
//Reads in project name and records Novascript file
//Attaches appropriate hooks to div sections in the index template
// model controls
// simulator controls
// visuals
// startup instantiates an instance of a project
// getNovaManager builds a simulation instance and attaches a novaManager
var globl=new Object
Novaol=function(t,e){this.index=e
var a=function(t){for(var e=t[0],a=1;a<t.length-1;a++)e=i(e,t[a])
return e},i=function(t,e){var a={}
for(var i in t)a[i]=t[i]
for(var i in e)if(i in t){var r=t[i],s=e[i]
if(Array.isArray(r)){var l=[]
for(var o in r)l[o]=r[o]
Array.isArray(s)?a[i]=n(r,s):(l.indexOf(s)<0&&l.push(s),a[i]=l)}else a[i]=r==s?r:new Array(r,s)}else a[i]=e[i]
return a},n=function(t,e){var a=[]
for(var i in t)a[i]=t[i]
for(var i in e)t.indexOf(e[i])<0&&a.push(e[i])
return a}
this.data=a(arguments),this.project=this.data.project,this.nmify="globl['"+this.project+"'].novaManager['"+this.index+"']",this.tag=this.project+"_"+this.index},Novaol.prototype.git0=function(t){return Array.isArray(t)?t[0]:t},Novaol.prototype.gitn=function(t){return Array.isArray(t)?t[t.length-1]:t},Novaol.prototype.timefield=function(){return[{type:"field",id:"timeval_"+this.tag,text:"Time",size:6,value:0}]},Novaol.prototype.simcontrols=function(){return[{type:"slider",id:"simhi",text:"Simulation End",min:this.data.clock.lo,max:this.data.clock.max,value:this.data.clock.hi,size:6,step:this.data.clock.step},{type:"slider",id:"simspeed",text:"Simulation Delay (ms)",min:0,max:2e3,value:0,size:6,step:10,chmore:this.nmify+".fixSpeed(this.value); "}]},Novaol.prototype.simbuttons=function(){return[{name:"reset",text:"Reset",onClick:this.nmify+".reset()",onDblClick:this.nmify+".dblReset()"},{name:"run",text:"Run",onClick:this.nmify+".run()"},{name:"stop",text:"Stop",onClick:this.nmify+".stop()"},{name:"continue",text:"Continue",onClick:this.nmify+".restart()"},{name:"step",text:"Step",onClick:this.nmify+".step()"}]},Novaol.prototype.control=function(t,e,a){var i=this.tag,n=this.nmify
t.selectAll("."+e).data(a).enter().append("td").each(function(t){if("slider"==t.type)d3.select(this).append("label").attr("for",t.id+"_slider_"+i).text(function(t){return t.text+": "}),d3.select(this).append("input").attr("id",t.id+"_slider_"+i).attr("type","range").attr("name",t.id+"_name_"+i).attr("min",t.min).attr("max",t.max).attr("value",t.value).attr("step",t.step).attr("onchange",t.change?t.change:n+".showSliderValue('"+t.id+"_field_"+i+"', this.value); "+(t.chmore?t.chmore:"")+(t.reset?n+".reset()":"")),d3.select(this).append("span").style("padding-left","5px").append("input").style("text-align","right").attr("id",t.id+"_field_"+i).attr("type","text").attr("size",t.size).attr("value",t.value).attr("readonly",!0)
else if("field"==t.type)d3.select(this).append("label").attr("for",t.id).text(t.text+": "),d3.select(this).append("input").style("text-align","readwrite"in t?"left":"right").attr("id",t.id).attr("type","text").attr("size",t.size).attr("value",t.value).attr("readonly","readwrite"in t?null:!0)
else if("switch"==t.type){var e=d3.select(this).append("table")
e.append("tr").append("td").attr("colspan",2).style("text-align","center").text(t.text)
var a=e.append("tr")
a.append("td").style("padding-left","0px").style("padding-right","5px").style("vertical-align","middle").style("text-align","right").append("label").attr("for",t.id+"_switch_"+i).append("font").attr("color","red").text(t.left)
var r=a.append("td").style("padding-left","5px").style("padding-right","0px").style("vertical-align","middle").style("text-align","left")
r.append("input").style("visibility","hidden").attr("type","checkbox").attr("id",t.id+"_switch_"+i).attr("name",t.id+"_switch_name_"+i).attr("checked",t.checked).attr("class","switch"),r.append("label").attr("for",t.id+"_switch_"+i).append("font").attr("color","green").text(t.right)}})},Novaol.prototype.buttons=function(t,e,a){t.selectAll("."+e).data(a).enter().append("button").attr("name",function(t){return t.name}).attr("onClick",function(t){return t.onClick}).text(function(t){return t.text}).each(function(t){"onDblClick"in t&&d3.select(this).attr("onDblClick",t.onDblClick)})},Novaol.prototype.populate=function(t){"css"in this.data&&d3.select("head").selectAll(".csslinks").data(this.data.css).enter().append("link").attr("rel","stylesheet").attr("type","text/css").attr("href",function(t){return"common/"+t+".css"}),"cssauto"in this.data&&d3.select("head").append("style").text(this.data.cssauto),d3.select("head").append("title").text(this.gitn(this.data.title)),d3.select("#simtitle").text(this.gitn(this.data.title))
var e="simbuttons"in this.data?this.simbuttons.concat(this.data.simbuttons(this.index)):this.simbuttons(),a="simcontrols"in this.data?this.data.simcontrols(this.index):this.simcontrols(),i="#SControls_"+this.tag
if("model_background"in this.data&&this.index in this.data.model_background,"model_wallpaper"in this.data&&this.index in this.data.model_wallpaper,this.control(d3.select(i).append("table").append("tr"),"ncsliders",a),this.buttons(d3.select(i).select("tr").append("td"),"ncbuttons",e),this.control(d3.select(i).select("tr"),"ncsliders",this.timefield()),"modcontrols"in this.data)for(var n=d3.select("#MControls_"+this.tag),r=0;r<this.data.modcontrols.length;r++){var s=this.data.modcontrols[r]
this.control(n.append("table").append("tr"),"controls",s)}if("visuals"in this.data)if(Array.isArray(this.data.visuals))for(var l=this.data.visuals.reverse(),r=0;r<l.length;r++)this.data.visuals[r](d3.select("#visuals_"+this.tag),this.project,this.index)
else this.data.visuals(d3.select("#visuals_"+this.tag),this.project,this.index)
if("address"in this.data)if("address"in globl||(globl.address=[]),Array.isArray(this.data.address))for(var r=0;r<this.data.address.length;r++)globl.address.indexOf(this.data.address[r])<0&&globl.address.push(this.data.address[r])
else globl.address.indexOf(this.data.address)<0&&globl.address.push(this.data.address)
"date"in this.data&&d3.select("#modified").text("Last Modified "+this.data.date),t&&t()},Novaol.prototype.signoff=function(){"address"in globl&&d3.select("#address").selectAll(".addresses").data(globl.address).enter().append("address").text(function(t){return t})},Novaol.prototype.control_builder=function(){for(var t={},e=("simcontrols"in this.data?this.git0(this.data.simcontrols(index)):this.simcontrols()),a=0;a<e.length;a++){var i=e[a]
t[i.id]=document.getElementById(i.id+"_"+i.type+"_"+this.tag),t[i.id].value=i.value}if(!("modcontrols"in this.data))return t
for(var n=this.data.modcontrols.reduce(function(t,e){return t.concat(e)}),a=0;a<n.length;a++){var i=n[a],r="field"==i.type?i.id:i.id+"_"+i.type+"_"+this.tag
t[i.id]=document.getElementById(r),t[i.id].value=i.value}return t},Novaol.prototype.get=function(t){var e=function(t,a){for(var i=0;i<t.length;i++){if(Array.isArray(a)){for(var n=0;n<a.length;n++)if(ans=e(t.slice(1),a[n]),null!=ans)return ans
return null}if("function"==typeof a&&i<t.length-1&&(a=a(this.project,this.index)),null==a)return null
var r=t[i]
a=a[r]}return a}.bind(this),a=t.split("."),i=e(a,this.data)
return i},Novaol.prototype.getAll=function(t){var e=function(t,a){for(var i=0;i<t.length;i++){if(Array.isArray(a)){for(var r=0;r<a.length;r++)if(n=e(t.slice(1),a[r]),null!=n)return n
return null}if("function"==typeof a&&(a=a(this.project,this.index)),null==a)return null
var s=t[i]
a=a[s]}return a}.bind(this),a=t.split("."),i=e(a,this.data),n={}
for(var r in i)n[r]=i[r]
return n},Novaol.getSyncScriptParams=function(){for(var t=document.getElementsByTagName("script"),e=t[t.length-1],a=e,i=new Object,n=0;n<arguments.length;n++){var r=a.getAttribute(arguments[n])
null!=r&&(i[arguments[n]]=r)}return i},Novaol.recordJSON=function(t){var e=Novaol.getSyncScriptParams("data-project")["data-project"]
globl[e]=new Object,t.project=e,globl[e].PData=t},Novaol.recordJS=function(t){var e=Novaol.getSyncScriptParams("data-project")["data-project"]
globl[e].main=t},Novaol.prototype.buildHTML=function(){var t=this.tag,e=d3.select("#"+t)
e.append("table").attr("id","SControls_"+t).attr("class","simControlTable"),e.append("hr"),e.append("table").attr("id","MControls_"+t).attr("class","modControlTable"),e.append("hr"),e.append("div").attr("id","visuals_"+t).attr("class","novaVisuals")},Novaol.startup=function(t,e){"controls"in globl[t]||(globl[t].controls=new Object),"novaManager"in globl[t]||(globl[t].novaManager=new Object),novaol=new Novaol(globl[t].PData,e),novaol.buildHTML(),novaol.populate(),globl[t].controls[e]=novaol.control_builder(),globl[t].postInterval=novaol.get("postinterval"),globl[t].novaManager[e]=novaol.getNovaManager()},Novaol.prototype.getNovaManager=function(){var t=this.project,e=this.index,a=this.get("clock.lo"),i=globl[t].controls[e].simhi,n=this.get("clock.dt"),r=this.get("clock.method"),s=SimGen(globl[t].main,globl[t].controls[e]),l={clock:new Clock(a,i,n,r),resetter:function(t){l.clock.reset(s)},updater:function(){}}
return l.clock.postInterval=globl[t].postInterval,l.resetter(),ans=NovaManager(l.updater,l.resetter,l.clock,document.getElementById("timeval_"+t+"_"+e),i,n,0,0),ans}
