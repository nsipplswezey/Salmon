function agentviewerx(Y,ab,Z,j,O,e,h,U){var a=ab*j,g=ab*Z,ag=ab,aj=Z,z=j;var K=(e)?e:20;var b=[],T=new Object(),ai=new Object();var I=[],af=new Object();var f=null;var d=null;if(O.cell){f=m(O.cell);d=m(O.agent)}else{f=m(O)}var i=(U)?U:null;var D=(i!=null);var al=h;var k=null,p,F,E=15;var A=false,w=false;var an=0;var ae=new Object();var ad=new Object();var V,R;if(al){V=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background-color","#FFFFAA").style("padding-left","3px").style("padding-right","3px")}function J(){d3.select(Y).select(".g_main_cell").remove();d3.select(Y).select(".g_main_agent").remove();if(!k){k=d3.select(Y).append("svg").attr("width",a).attr("height",g).append("g").attr("id","g_main_parent");var u=k.append("svg:defs");u.append("svg:clipPath").attr("id","crect").append("svg:rect").attr("x",0).attr("y",0).attr("width",a).attr("height",g)}F=k.append("g").attr("class","g_main_cell").attr("transform","translate(0, 0)");p=k.append("g").attr("class","g_main_agent").attr("transform","translate(0, 0)");var ap=k.on("ondragstart",function(){return false}).on("ondrag",function(){A=true;w=true;var aq=d3.mouse(this)[0];var at=d3.mouse(this)[1];var ar=af[X(Math.floor(at/ag),Math.floor(aq/ag))];if(ar){ae[ar.id]=ar;an=ar.colorIdx;n([ar])}}).on("mousedown",function(){d3.event.preventDefault();A=true;var aq=d3.mouse(this)[0];var at=d3.mouse(this)[1];var ar=af[X(Math.floor(at/ag),Math.floor(aq/ag))];if(ar){an=ar.colorIdx}}).on("mouseup",function(){A=false}).on("mousemove",function(){if(A){w=true;var aq=d3.mouse(this)[0];var au=d3.mouse(this)[1];var ar=af[X(Math.floor(au/ag),Math.floor(aq/ag))];L(ar,an);if(al){return V.style("visibility","hidden")}}else{if(al){var aq=d3.mouse(this)[0];var au=d3.mouse(this)[1];var at=X(Math.floor(au/ag),Math.floor(aq/ag));var ar=DataMap[at];R=at;return V.style("top",(event.pageY-10)+"px").style("left",(event.pageX+10)+"px").text(ar.colorIdx)}}}).on("click",function(){d3.event.preventDefault();if(w){w=false;return}var av=Math.floor(d3.mouse(this)[0]/ag);var ar=Math.floor(d3.mouse(this)[1]/ag);if(d3.event.shiftKey){var at=q(av,ar);if(!at){var aw=av+0.5;var au=ar+0.5;var at={id:b.length,cx:aw,cy:au,colorIdx:0,r:ag/2,ix:aw,iy:au};if(D){at.image=v(at.colorIdx)}o(at);ad[at.id]=at;S(b)}else{var az=Object.keys((D)?i:d);var ay=nsutil.binaryIndexOf(az,at.colorIdx);var ax;if(+az[ay]>at.colorIdx){ax=+az[ay]}else{if(ay<az.length-1){ax=+az[ay+1]}else{ax=null}}if(ax!=null){at.colorIdx=ax;if(D){at.image=v(at.colorIdx)}ad[at.id].colorIdx=ax}else{ak(at);ad=new Object();for(var aq in T){ad[aq]=T[aq]}}S(b)}}else{var at=af[X(ar,av)];var az=Object.keys(f);var ay=nsutil.binaryIndexOf(az,at.colorIdx);var ax;if(+az[ay]>at.colorIdx){ax=+az[ay]}else{ax=+az[(ay+1)%az.length]}L(at,ax);if(al){V.text(at.colorIdx)}A=false}});if(al){ap=ap.on("mouseover",function(){var aq=d3.mouse(this)[0];var au=d3.mouse(this)[1];var at=X(Math.floor(au/ag),Math.floor(aq/ag));var ar=DataMap[at];R=at;return V.style("visibility","visible").text(ar.colorIdx)}).on("mouseout",function(){R=null;return V.style("visibility","hidden")})}F.append("g").attr("id","cellmatrix")}function L(ap,u){if(ap){ae[ap.id]=ap;ap.colorIdx=u;n([ap])}}function l(ap,ar,aq,u){I.push({r:x,c:y,id:aq,colorIdx:u})}function s(u,au,aq,at,ap){var ar={x:u,y:au,r:aq,id:at,colorIdx:ap};if(D){rec.image=v(rec.colorIdx)}b.push(ar)}function N(){I=[];af=new Object();b=[];T=new Object();ai=new Object()}function n(ap){var u=F.select("#cellmatrix").selectAll("rect").data(ap,function(aq){return aq.id});u.enter().append("rect").attr("clip-path","url(#crect)").attr("id",function(aq){return aq.id}).attr("x",0).attr("y",0).attr("width",ag+1).attr("height",ag+1).attr("transform",function(aq){return"translate("+ag*aq.c+", "+ag*aq.r+")"}).attr("fill",function(aq){return H(aq.colorIdx,f)});u.attr("fill",function(aq){return H(aq.colorIdx,f)})}function S(av){var aq=[];var ap=[];for(var at in av){if(av[at].wrapped){ap.push(av[at])}else{aq.push(av[at])}}if(D){var u=p.selectAll("image").data(av);u.exit().remove();var au=p.selectAll("image").data(aq);au.enter().append("image").attr("id",function(aw){return"A"+aw.id}).attr("clip-path","url(#crect)").attr("transform",function(aw){return"translate("+(ag*aw.cx-aw.image.size[0]/2)+","+(ag*aw.cy-aw.image.size[1]/2)+")"}).attr("xlink:href",function(aw){return aw.image.src}).attr("x",0).attr("y",0).attr("height",function(aw){return aw.image.size[1]}).attr("width",function(aw){return aw.image.size[0]});au.attr("xlink:href",function(aw){return aw.image.src}).attr("height",function(aw){return aw.image.size[1]}).attr("width",function(aw){return aw.image.size[0]});au.transition().duration(K).attr("transform",function(aw){return"translate("+(ag*aw.cx-aw.image.size[0]/2)+","+(ag*aw.cy-aw.image.size[1]/2)+")"});var ar=k.selectAll("image").data(ap);ar.attr("transform",function(aw){return"translate("+(ag*aw.cx-aw.image.size[0]/2)+","+(ag*aw.cy-aw.image.size[1]/2)+")"}).select("image").attr("xlink:href",function(aw){return aw.image.src}).attr("height",function(aw){return aw.image.size[1]}).attr("width",function(aw){return aw.image.size[0]})}else{var u=p.selectAll("circle").data(av,function(aw){return aw.id});u.exit().remove();var au=p.selectAll("circle").data(aq,function(aw){return aw.id});au.enter().append("circle").attr("clip-path","url(#crect)").attr("id",function(aw){return"A"+aw.id}).attr("cx",function(aw){return ag*aw.cx}).attr("cy",function(aw){return ag*aw.cy}).attr("r",function(aw){return(aw.r)?aw.r:E}).attr("fill",function(aw){return(aw.colorIdx==-1)?aw.color:H(aw.colorIdx,d)});au.attr("r",function(aw){return(aw.r)?aw.r:E}).attr("fill",function(aw){return(aw.colorIdx==-1)?aw.color:H(aw.colorIdx,d)});au.transition().duration(K).attr("cx",function(aw){return ah(ag*aw.cx,a)}).attr("cy",function(aw){return ah(ag*aw.cy,g)});var ar=p.selectAll("circle").data(ap,function(aw){return aw.id});ar.attr("cx",function(aw){return ah(ag*aw.cx,a)}).attr("cy",function(aw){return ah(ag*aw.cy,g)}).attr("r",function(aw){return aw.r}).style("fill",function(aw){return(aw.colorIdx==-1)?aw.color:H(aw.colorIdx,d)})}}function m(ar){if(!ar){return ar}if(Array.isArray(ar)){return ar}var aq=Object.keys(ar);var u=new Array();for(var ap in aq){u[+aq[ap]]=ar[aq[ap]]}return u}function B(aq,ar,ap){ag=aq;aj=ar;z=ap;a=aq*ap;g=aq*ar;J();n(I);updateAgents(b)}function c(aq){for(var u in aq){var ap=aq[u];var ar={id:ap.id,cx:ap.cx,cy:ap.cy,r:(ap.r)?ap.r:5+15*Math.random(),colorIdx:(ap.colorIdx==undefined)?-1:ap.colorIdx,image:(D)?v(ap.colorIdx):null,color:(ap.colorIdx==undefined)?G():0,wrapped:false,ix:ap.cx,iy:ap.cy};o(ar)}S(b)}function o(ar){b.push(ar);T[ar.id]=ar;var ap=P(ar.ix,ar.iy);var aq=ai[ap];if(!aq){ai[ap]=ar}else{if(Array.isArray(aq)){aq.unshift(ar)}else{var u=[ar,aq];ai[ap]=u}}}function q(u,ar){var ap=P(u,ar);var aq=ai[ap];if(Array.isArray(aq)){return aq[0]}return aq}function W(aq){for(var ap in aq){delete T[aq[ap]]}var u=T;b=new Array();T=new Object();ai=new Object();ad=new Object();for(var ar in u){o(u[ar])}}function ak(u){delete T[u.id];t()}function t(){var u=T;var at=ad;b=new Array();T=new Object();ai=new Object();ad=new Object();var ap=0;for(var ar in u){var aq=u[ar];aq.id=ap++;o(aq);if(at[ar]){ad[aq.id]=aq}}}function G(){var u="#";for(var ap=0;ap<3;ap++){u=u+Math.floor(16*Math.random()).toString(16)}return u}function ah(ap,u){return(ap+u)%u}function r(u){if(u.length>0){c(u)}}function C(u){if(u.length>0){W(u)}}function aa(at,aq){N();J();if(at.length>0){c(at)}for(var ap in aq){var ar=aq[ap];I.push(ar);af[ar.id]=ar}for(var ap=0;ap<aj;ap++){for(var u=0;u<z;u++){var av=X(ap,u);if(af[av]){continue}var au={id:av,r:ap,c:u,color:0};I.push(au);af[av]=au}}n(I)}function Q(at,aq){var au=[];for(var ap in at){var av=at[ap];var aw=T[av.id];if(!aw){continue}var ar=Object.keys(av);for(var u in ar){aw[ar[u]]=av[ar[u]]}if(D){aw.image=v(aw.colorIdx)}}n(aq);S(b)}function v(u){return i[Math.round(u)]}function M(){return ae}function am(){return ad}function X(ap,u){return"C"+ap+":"+u}function P(ap,u){return"A"+Math.floor(ap)+":"+Math.floor(u)}function ac(ap){var u=ap.substring(1).split(":");return{row:+u[0],col:+u[1]}}function ao(ap,aq,u){document.getElementById("g_main_parent").addEventListener(ap,aq,u)}aa([],[]);function H(av,ap){if(av==undefined){return ap[0]}if(av in ap){return ap[av]}var at=Object.keys(ap);if(av<=+at[0]){return ap[at[0]]}if(av>=+at[at.length-1]){return ap[at[at.length-1]]}var ar=0;while(!(av>=+at[ar]&&av<+at[ar+1])){ar++}var au=(+at[ar+1])-(+at[ar]);var u=(av-(+at[ar]))/au;clow=d3.rgb(ap[at[ar]]);chi=d3.rgb(ap[at[ar+1]]);var aq=d3.interpolate(clow,chi)(u);return aq}return{render:Q,reset:aa,getInitCellBucket:M,getInitAgentBucket:am,cIdMaker:X,aIdMaker:P,parseId:ac,create:r,kill:C,addEventListener:ao}};