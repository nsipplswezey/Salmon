function netviewer(P,Q,h,T,m,F,H,J,aa){var V=T,Z=Q,t=h,a=Q*h;var E=(m)?m:100,l=d3.rgb((F)?F:"#444"),y="#444";var q=0;var g=J;var v=(aa)?aa:"#ffffff";var b=V*t,f=V*Z;var s=V*Z,S=V*t,i=3*V/7,L=i/2;var W=[],A=[],I=new Object();var U=k(H);var j,p,M;var e=d3.scale.linear().domain([0,E]).range([0,U.length]);var O=d3.scale.linear().domain(d3.range(U.length)).range(U);var C=d3.scale.linear().domain([-1,E]).range([0,i]);var X;function D(){d3.select(P).select("svg").remove();j=d3.select(P).append("svg").attr("width",b).attr("height",f).attr("class","g_main_agent").attr("transform","translate(0, 0)");X=j.append("svg:defs");X.append("svg:clipPath").attr("id","crect").append("svg:rect").attr("x",0).attr("y",0).attr("width",b).attr("height",f);X.selectAll("marker").data(["arrow_red","arrow_black"]).enter().append("svg:marker").attr("id",function(u){return u}).attr("viewBox","0 0 10 10").attr("refX",8).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",5).attr("markerHeight",3).attr("orient","auto").attr("fill",function(u){return u.substring(6)}).append("svg:path").attr("d","M 0 0 L 10 5 L 0 10 z");j.append("rect").attr("class","click-capture").attr("x",0).attr("y",0).attr("width",b).attr("height",f).style("fill",v);p=j.append("g").attr("id","circles");M=j.append("g").attr("id","lines")}function G(){W=[];A=[];I=new Object()}function z(ae,ac){lscale=d3.scale.linear().domain([0,d3.max(ac,function(af){return af.strength})]).range([0,16]);q=Math.max(q,d3.max(ac,function(af){return(af.flow)?af.flow:0}));if(!J){var ad=X.selectAll("marker.colormarker").data(ac,function(af){return af.source*a+af.target});ad.enter().append("svg:marker").attr("id",function(af){var ag=af.source*a+af.target;return"arrow_"+ag}).attr("class","colormarker").attr("viewBox","0 0 10 10").attr("refX",8).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",5).attr("markerHeight",3).attr("orient","auto").append("svg:path").attr("d","M 0 0 L 10 5 L 0 10 z").attr("fill",d);ad.selectAll("path").data(ac,function(af){return af.source*a+af.target}).attr("fill",d)}var u=M.selectAll("line").data(ac,function(af){return af.source*a+af.target});u.enter().append("line").attr("x1",function(af){return af.endpts.x1}).attr("x2",function(af){return af.endpts.x2}).attr("y1",function(af){return af.endpts.y1}).attr("y2",function(af){return af.endpts.y2}).attr("stroke",d).attr("stroke-width",function(af){return Math.sqrt(lscale(af.strength))}).attr("marker-end",r).on("mouseover",function(af){af.mousein=true;d3.select(this).style("stroke","red").attr("marker-end","url(#arrow_red)").append("svg:title").text(af.flow)}).on("mouseout",function(af){af.mousein=false;d3.select(this).style("stroke",d).attr("marker-end",r(af));M.selectAll("title").remove()});u.attr("x1",function(ai){var ag=I[ai.source];var ah=I[ai.target];var af=o(V*ag.cx+i,V*ag.cy+i,V*ah.cx+i,V*ah.cy+i,ag.r,ah.r);ai.endpts=af;return ai.endpts.x1}).attr("x2",function(af){return af.endpts.x2}).attr("y1",function(af){return af.endpts.y1}).attr("y2",function(af){return af.endpts.y2}).attr("stroke",d).attr("marker-end",function(af){return(af.mousein)?"url(#arrow_red)":r(af)});u.exit().remove();u=p.selectAll("circle").data(ae,function(af){return af.id});u.enter().append("circle").attr("clip-path","url(#crect)").attr("id",function(af){return"A"+af.id}).attr("cx",function(af){return V*af.cx+i}).attr("cy",function(af){return V*af.cy+i}).attr("r",function(af){return af.r}).attr("fill",function(af){return af.color}).on("mouseover",function(af){d3.select(this).append("svg:title").text(function(){return af.wt})}).on("mouseout",function(af){d3.select(this).selectAll("title").remove()});u.attr("r",function(af){return af.r}).attr("fill",function(af){return af.color})}function r(u){if(g||!u.flow){return"url(#arrow_black)"}var ac=u.source*a+u.target;return"url(#arrow_"+ac+")"}function d(ac){if(ac.flow){var u=10*ac.flow/q;return d3.rgb(u*l.r,u*l.g,u*l.b)}return y}function o(ak,ae,aj,ac,ai,ah){var aq=aj-ak;var ao=ac-ae;var ag=Math.atan2(ao,aq);var al=Math.sqrt(aq*aq+ao*ao);var u=al-ah;var ap=u/al;var af=ak+ai*Math.cos(ag);var an=ae+ai*Math.sin(ag);var ad=ak+(aj-ak)*ap;var am=ae+(ac-ae)*ap;return{x1:af,x2:ad,y1:an,y2:am}}function w(u,ac){b=u;f=ac;D();z(W,A)}function c(ac,u){if(ac.length==0){return}for(var ad in ac){var ah=Y(ac[ad]);W.push(ah);I[ac[ad].id]=ah}for(var ad in u){connect=u[ad];var af=I[connect.source];var ag=I[connect.target];var ae=o(V*af.cx+i,V*af.cy+i,V*ag.cx+i,V*ag.cy+i,af.r,ag.r);connect.endpts=ae;A.push(connect)}z(W,A)}function K(ac,u){if(ac.length==0){return}for(var ad in ac){var ae=ac[ad];var af=I[ae.id];if(!af){af={};W.push(af);I[ae.id]=af}Y(ae,af)}z(W,A)}function Y(u,ac){if(!ac){ac={}}ac.id=u.id;ac.cy=Math.floor(u.id/t);ac.cx=u.id%t;ac.wt=u.wt;ac.r=(u.r)?u.r:("wt" in u)?Math.min(C(u.wt),C(E)):L;ac.color=(u.color)?u.color:(u.wt!=null)?O(e(u.wt)):B();return ac}function B(){var u="#";for(var ac=0;ac<3;ac++){u=u+Math.floor(16*Math.random()).toString(16)}return u}function n(ac,u){c(ac,u)}function x(ac){if(ac.length==0){return}for(var u in ac){delete I[ac[u]]}W=new Array();for(var ad in I){W.push(I[ad])}}function R(ac,u){G();D();c(ac,u)}function ab(u){return{cy:Math.floor(u/t),cx:u%t}}function N(u){return u.cy*t+u.cx}function k(ae){if(!ae){return ae}if(Array.isArray(ae)){return ae}var ad=Object.keys(ae);var u=new Array();for(var ac in ad){u[+ad[ac]]=ae[ad[ac]]}return u}R([],[]);return{render:K,reset:R,create:n,kill:x,idToCoords:ab,coordsToId:N}};